<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="zhuhui&#39;s yard">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="zhuhui&#39;s yard">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="朱辉">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>zhuhui's yard</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">zhuhui's yard</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/17/Note/%E7%AC%94%E8%AE%B0/%E5%AE%9E%E9%AA%8C/SDN%E5%AE%9E%E9%AA%8C/%E5%AE%9E%E9%AA%8C%E5%9B%9BREADME/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱辉">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuhui's yard">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/17/Note/%E7%AC%94%E8%AE%B0/%E5%AE%9E%E9%AA%8C/SDN%E5%AE%9E%E9%AA%8C/%E5%AE%9E%E9%AA%8C%E5%9B%9BREADME/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-17 21:04:46" itemprop="dateCreated datePublished" datetime="2021-07-17T21:04:46+08:00">2021-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-02 22:05:35" itemprop="dateModified" datetime="2021-07-02T22:05:35+08:00">2021-07-02</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="实验四"><a href="#实验四" class="headerlink" title="实验四"></a>实验四</h3><h5 id="计算机84-朱辉-2183414205"><a href="#计算机84-朱辉-2183414205" class="headerlink" title="计算机84 朱辉 2183414205"></a>计算机84 朱辉 2183414205</h5><h4 id="EC数目打印"><a href="#EC数目打印" class="headerlink" title="EC数目打印"></a>EC数目打印</h4><ul>
<li><p>在<code>VeriFlow.cpp</code>中修改如下代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// fprintf(stdout, &quot;\n&quot;);</span></span><br><span class="line">		<span class="comment">// fprintf(stdout, &quot;[VeriFlow::verifyRule] ecCount: %lu\n&quot;, ecCount);</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>修改为</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(fp, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(fp,<span class="string">&quot;verifying this rule: %s\n&quot;</span>,rule.<span class="built_in">toString</span>().<span class="built_in">c_str</span>());</span><br><span class="line">		<span class="built_in">fprintf</span>(fp, <span class="string">&quot;[VeriFlow::verifyRule] ecCount: %lu\n&quot;</span>, ecCount);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>运行结果</p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210610212627247.png" alt="image-20210610212627247"></p>
</li>
</ul>
<h4 id="环路路径打印"><a href="#环路路径打印" class="headerlink" title="环路路径打印"></a>环路路径打印</h4><ul>
<li><p>将<code>traverseForwardingGraph</code>函数中<code>visited</code>容器改为顺序容器<code>vector</code>,并修改相关的函数声明,加入头文件,然后按格式输出其内容.</p>
</li>
<li><p>主要代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;visited.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(visited[i].<span class="built_in">c_str</span>(),currentLocation.<span class="built_in">c_str</span>()) == <span class="number">0</span>)&#123;</span><br><span class="line">        flag = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(flag == <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Found a loop.</span></span><br><span class="line">    <span class="built_in">fprintf</span>(fp, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, <span class="string">&quot;[VeriFlow::traverseForwardingGraph] Found a LOOP for the following packet class at node %s.\n&quot;</span>, currentLocation.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, <span class="string">&quot;[VeriFlow::traverseForwardingGraph] PacketClass: %s\n&quot;</span>, packetClass.<span class="built_in">toString</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="built_in">fprintf</span>(fp,<span class="string">&quot;[VeriFlow::traverseForwardingGraph] Loop path is:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; visited.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(fp,<span class="string">&quot;%s -&gt; &quot;</span>,visited[i].<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fprintf</span>(fp,<span class="string">&quot;%s\n\n&quot;</span>,currentLocation.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; faults.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (packetClass.<span class="built_in">subsumes</span>(faults[i])) &#123;</span><br><span class="line">            faults.<span class="built_in">erase</span>(faults.<span class="built_in">begin</span>() + i);</span><br><span class="line">            i--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    faults.<span class="built_in">push_back</span>(packetClass);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>运行结果</p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210611154832199.png" alt="image-20210611154832199"></p>
</li>
</ul>
<h4 id="相关数据包信息的打印"><a href="#相关数据包信息的打印" class="headerlink" title="相关数据包信息的打印"></a>相关数据包信息的打印</h4><ul>
<li><p>修改<code>EquivalenceClass</code>类中的<code>toString</code>方法，使其按照相应的格式将类转换为字符串。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">EquivalenceClass::toString</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">	<span class="built_in">sprintf</span>(buffer, <span class="string">&quot;nw_src (%s-%s), nw_dst (%s-%s), nw_proto (%ld-%ld), tp_src (%ld-%ld), tp_dst(%ld-%ld)&quot;</span>,</span><br><span class="line">		::<span class="built_in">getIpValueAsString</span>(<span class="keyword">this</span>-&gt;lowerBound[NW_SRC]).<span class="built_in">c_str</span>(),::<span class="built_in">getIpValueAsString</span>(<span class="keyword">this</span>-&gt;upperBound[NW_SRC]).<span class="built_in">c_str</span>(),</span><br><span class="line">		::<span class="built_in">getIpValueAsString</span>(<span class="keyword">this</span>-&gt;lowerBound[NW_DST]).<span class="built_in">c_str</span>(),::<span class="built_in">getIpValueAsString</span>(<span class="keyword">this</span>-&gt;upperBound[NW_DST]).<span class="built_in">c_str</span>(),</span><br><span class="line">		<span class="keyword">this</span>-&gt;lowerBound[NW_PROTO],<span class="keyword">this</span>-&gt;upperBound[NW_PROTO],</span><br><span class="line">		<span class="keyword">this</span>-&gt;lowerBound[TP_SRC],<span class="keyword">this</span>-&gt;upperBound[TP_DST],</span><br><span class="line">		<span class="keyword">this</span>-&gt;lowerBound[TP_DST],<span class="keyword">this</span>-&gt;upperBound[TP_DST]</span><br><span class="line">	);</span><br><span class="line">	string retVal = buffer;</span><br><span class="line">	<span class="keyword">return</span> retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>运行结果</p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210611155150358.png" alt="image-20210611155150358"></p>
</li>
</ul>
<h4 id="打补丁的原因"><a href="#打补丁的原因" class="headerlink" title="打补丁的原因"></a>打补丁的原因</h4><p>在命令行执行<code>git diff HEAD origin/HEAD</code>得到打补丁之后的代码和源代码之间的区别。由指令执行结果可得，打补丁之后删除了<code>in_port</code>和<code>lasthop</code>,同时增加了一个检测黑洞的方法</p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210613214852975.png" alt="image-20210613214852975"></p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210613215333353.png" alt="image-20210613215333353"></p>
<p>增加了检测黑洞的方法之后，程序对黑洞的检测能力增强，因此修改后的程序相较于之前的程序会检测出更多的黑洞。</p>
<h4 id="实验中的问题"><a href="#实验中的问题" class="headerlink" title="实验中的问题"></a>实验中的问题</h4><ul>
<li><p>启动最短路径控制程序时提示<code>No module named &#39;networkx&#39;</code></p>
<p>使用<code>pip install networkx</code>即可</p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210607083842790.png" alt="image-20210607083842790"></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/17/Note/%E7%AC%94%E8%AE%B0/%E5%AE%9E%E9%AA%8C/SDN%E5%AE%9E%E9%AA%8C/%E5%AE%9E%E9%AA%8C%E4%B8%89README/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱辉">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuhui's yard">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/17/Note/%E7%AC%94%E8%AE%B0/%E5%AE%9E%E9%AA%8C/SDN%E5%AE%9E%E9%AA%8C/%E5%AE%9E%E9%AA%8C%E4%B8%89README/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-17 21:04:46" itemprop="dateCreated datePublished" datetime="2021-07-17T21:04:46+08:00">2021-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-02 22:04:55" itemprop="dateModified" datetime="2021-07-02T22:04:55+08:00">2021-07-02</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>28k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>25 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="实验三"><a href="#实验三" class="headerlink" title="实验三"></a>实验三</h3><h4 id="解决ARP洪泛"><a href="#解决ARP洪泛" class="headerlink" title="解决ARP洪泛"></a>解决ARP洪泛</h4><ul>
<li><p>基本思路</p>
<p>每次收到ARP包,首先检查发送此包的主机的IP地址是否被记录.如果没被记录,则记录IP地址、MAC地址、和主机直接相连的交换机的id和端口.</p>
<p>学习完之后,查看ARP请求的目的IP地址是否在记录当中.如果在,则直接取出对应的MAC地址,构造ARP回复报文,发回源主机;如果不在,则记录目的IP地址和转发过此ARP请求报文的交换机的id,当此交换机收到ARP请求报文时,根据目的IP查找本交换机id是否被记录.如果被记录,则直接丢弃报文,否则记录后进行洪泛.此时每个交换机对于请求同一个目标IP的ARP请求报文最多只处理一次,因为此IP地址在交换机收到ARP回复时一定会被学习到.</p>
</li>
<li><p>代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@set_ev_cls(<span class="params">ofp_event.EventOFPPacketIn, MAIN_DISPATCHER</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_packet_in_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">    <span class="keyword">if</span> ev.msg.msg_len &lt; ev.msg.total_len:</span><br><span class="line">        self.logger.debug(<span class="string">&quot;packet truncated: only %s of %s bytes&quot;</span>,ev.msg.msg_len, ev.msg.total_len)</span><br><span class="line">    msg = ev.msg</span><br><span class="line">    datapath = msg.datapath</span><br><span class="line">    ofproto = datapath.ofproto</span><br><span class="line">    parser = datapath.ofproto_parser</span><br><span class="line">    in_port = msg.match[<span class="string">&#x27;in_port&#x27;</span>]</span><br><span class="line">  </span><br><span class="line">    pkt = packet.Packet(msg.data)</span><br><span class="line">    eth = pkt.get_protocols(ethernet.ethernet)[<span class="number">0</span>]</span><br><span class="line">    pkt_arp = pkt.get_protocol(arp.arp)</span><br><span class="line">    pkt_ipv4 = pkt.get_protocol(ipv4.ipv4)</span><br><span class="line">    pkt_tcp = pkt.get_protocol(tcp.tcp)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> eth.ethertype == ether_types.ETH_TYPE_LLDP:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">  </span><br><span class="line">    dst = eth.dst</span><br><span class="line">    src = eth.src</span><br><span class="line">    dpid = datapath.<span class="built_in">id</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment"># in rest_topology, self.mac_to_port is for the find for host</span></span><br><span class="line">    self.mac_to_port.setdefault(dpid, &#123;&#125;)</span><br><span class="line">    self.mac_to_port[dpid][src] = in_port</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># arp handle</span></span><br><span class="line">    <span class="keyword">if</span> pkt_arp <span class="keyword">and</span> pkt_arp.opcode == arp.ARP_REQUEST:</span><br><span class="line">        <span class="keyword">if</span> pkt_arp.src_ip <span class="keyword">not</span> <span class="keyword">in</span> self.ip_to_mac:</span><br><span class="line">            self.ip_to_mac[pkt_arp.src_ip] = src                                <span class="comment"># 主机ip地址和MAC地址的映射    IP：MAC</span></span><br><span class="line">            self.mac_to_dpid[src] = (dpid, in_port)                             <span class="comment"># 主机MAC地址和与主机相连的交换机的dpid的映射   MAC:(dpid,in_port)</span></span><br><span class="line">            self.ip_to_port[pkt_arp.src_ip] = (dpid, in_port)                   <span class="comment"># 主机IP地址和与主机相连的交换机的dpid的映射    IP:(dpid,in_port)</span></span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> pkt_arp.dst_ip <span class="keyword">in</span> self.ip_to_mac:                                    <span class="comment"># 查询的MAC地址已经学习过了</span></span><br><span class="line">            self.handle_arpre(datapath=datapath, port=in_port,src_mac=self.ip_to_mac[pkt_arp.dst_ip],</span><br><span class="line">                            dst_mac=src, src_ip=pkt_arp.dst_ip, dst_ip=pkt_arp.src_ip)</span><br><span class="line">        <span class="keyword">else</span>:                                                                   <span class="comment"># 查询的MAC地址没有被学习过</span></span><br><span class="line">            <span class="comment"># to avoid flood when the dst ip not in the network                 每个交换机对于一个ARP包只接收处理一次，重复的则丢弃</span></span><br><span class="line">            <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> self.check_ip_dpid[pkt_arp.dst_ip]:</span><br><span class="line">                self.check_ip_dpid[pkt_arp.dst_ip].append(datapath.<span class="built_in">id</span>)          <span class="comment"># 目的主机IP地址和与收到ARP包的交换机的dpid    IP:dpid</span></span><br><span class="line">                out_port = ofproto.OFPP_FLOOD</span><br><span class="line">                actions = [parser.OFPActionOutput(out_port)]</span><br><span class="line">                data = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">if</span> msg.buffer_id == ofproto.OFP_NO_BUFFER:</span><br><span class="line">                    data = msg.data</span><br><span class="line">                out = parser.OFPPacketOut(datapath=datapath, buffer_id=msg.buffer_id,in_port=in_port, actions=actions, data=data)</span><br><span class="line">                datapath.send_msg(out)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment"># ARP回复包直接转发到相应的交换机</span></span><br><span class="line">    <span class="keyword">elif</span> pkt_arp <span class="keyword">and</span> pkt_arp.opcode == arp.ARP_REPLY:</span><br><span class="line">        <span class="keyword">if</span> pkt_arp.src_ip <span class="keyword">not</span> <span class="keyword">in</span> self.ip_to_mac:</span><br><span class="line">            self.ip_to_mac[pkt_arp.src_ip] = src</span><br><span class="line">            self.mac_to_dpid[src] = (dpid, in_port)</span><br><span class="line">            self.ip_to_port[pkt_arp.src_ip] = (dpid, in_port)</span><br><span class="line">        dst_mac = self.ip_to_mac[pkt_arp.dst_ip]</span><br><span class="line">        (dst_dpid, dst_port) = self.mac_to_dpid[dst_mac]</span><br><span class="line">        self.handle_arpre(datapath=self.datapaths[dst_dpid], port=dst_port, src_mac=src, dst_mac=dst_mac,</span><br><span class="line">                        src_ip=pkt_arp.src_ip, dst_ip=pkt_arp.dst_ip)</span><br><span class="line">        <span class="keyword">return</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="跳数最少的线路"><a href="#跳数最少的线路" class="headerlink" title="跳数最少的线路"></a>跳数最少的线路</h4><ul>
<li><p>基本思路</p>
<p>使用<code>ryu.topology.api.get_link()</code>获取整个网络拓扑.然后将每一跳的权值赋为1,使用Dijkstra算法求出最短路径即为跳数最少的路径.</p>
</li>
<li><p>代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">short_path</span>(<span class="params">self, src, dst</span>):</span></span><br><span class="line">    <span class="keyword">if</span> src == dst:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    result = defaultdict(<span class="keyword">lambda</span>: defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>))</span><br><span class="line">    distance = defaultdict(<span class="keyword">lambda</span>:<span class="literal">None</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># the node is checked</span></span><br><span class="line">    seen = [src]</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># the distance to src</span></span><br><span class="line">    distance[src] = <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(seen) &lt; <span class="built_in">len</span>(self.src_links):</span><br><span class="line">        node = seen[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> node == dst:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> (temp_src, temp_dst) <span class="keyword">in</span> self.src_links[node]:</span><br><span class="line">            <span class="keyword">if</span> temp_dst <span class="keyword">not</span> <span class="keyword">in</span> seen:</span><br><span class="line">                temp_src_port = self.src_links[node][(temp_src, temp_dst)][<span class="number">0</span>]</span><br><span class="line">                temp_dst_port = self.src_links[node][(temp_src, temp_dst)][<span class="number">1</span>]</span><br><span class="line">                <span class="keyword">if</span> (distance[temp_dst] <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> (distance[temp_dst] &gt; distance[temp_src] + self.delay[(temp_src,temp_dst)]):</span><br><span class="line">                    distance[temp_dst] = distance[temp_src] + self.delay[(temp_src,temp_dst)]</span><br><span class="line">                    <span class="comment"># result = &#123;&quot;dpid&quot;:(link_src, src_port, link_dst, dst_port)&#125;</span></span><br><span class="line">                    result[temp_dst] = (temp_src, temp_src_port, temp_dst, temp_dst_port)</span><br><span class="line">        min_node = <span class="literal">None</span></span><br><span class="line">        min_path = <span class="number">999</span></span><br><span class="line">        <span class="comment"># get the min_path node</span></span><br><span class="line">        <span class="keyword">for</span> temp_node <span class="keyword">in</span> distance:</span><br><span class="line">            <span class="keyword">if</span> (temp_node <span class="keyword">not</span> <span class="keyword">in</span> seen) <span class="keyword">and</span> (distance[temp_node] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">                <span class="keyword">if</span> distance[temp_node] &lt; min_path:</span><br><span class="line">                    min_node = temp_node</span><br><span class="line">                    min_path = distance[temp_node]</span><br><span class="line">        <span class="keyword">if</span> min_node <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        seen.append(min_node)</span><br><span class="line">  </span><br><span class="line">    path = []</span><br><span class="line">    self.min_dist = distance[dst]</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> dst <span class="keyword">not</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> (dst <span class="keyword">in</span> result) <span class="keyword">and</span> (result[dst] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">        path = [result[dst][<span class="number">2</span>:<span class="number">4</span>]] + path</span><br><span class="line">        path = [result[dst][<span class="number">0</span>:<span class="number">2</span>]] + path</span><br><span class="line">        dst = result[dst][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> path</span><br></pre></td></tr></table></figure></li>
<li><p>实验结果截图</p>
<p><img src="D:\Vnote\图片\image-20210528224454591.png" alt="image-20210528224454591"></p>
<p>此网络应该有两条跳数相同的最短路径,分别为下图所示</p>
<p><img src="D:\Vnote\图片\image-20210528224409191.png" alt="image-20210528224409191"></p>
<p><img src="D:\Vnote\图片\image-20210529091837768.png" alt="image-20210529091837768"></p>
</li>
</ul>
<h4 id="时延最短的线路"><a href="#时延最短的线路" class="headerlink" title="时延最短的线路"></a>时延最短的线路</h4><ul>
<li><p>将<code>ryu/topology/switches.py</code>按照要求修改之后,重新编译安装Ryu</p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210527185301840.png" alt="image-20210527185301840"></p>
</li>
<li><p>获取lldp_delay和echo_delay</p>
<p>lldp_delay:LLDP包附在packet-in包中,所以每次控制器收到packet-in包,使用<code>LLDPPacket.lldp_parse</code>判断是否为lldp包.如果是,将相应的时延写入<code>self.lldp_delay</code>中.</p>
<p>echo_delay:每次控制器收到一个lldp包,在处理完之后,向发送lldp包的交换机发送一个带有时间戳信息的<code>ECHO Request</code>报文.交换机收到之后会向控制器回复一个<code>ECHO Reply</code>报文.交换机收到回复报文,调用<code>echo_rep_hander</code>函数,用收到报文时的时间戳减去报文中的时间戳即得交换机和控制器之间时延的2倍,将此时延写入<code>self.echo_delay</code>中.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@set_ev_cls(<span class="params">ofp_event.EventOFPPacketIn,MAIN_DISPATCHER</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">packet_in_hander</span>(<span class="params">self,ev</span>):</span></span><br><span class="line">    msg = ev.msg</span><br><span class="line">    datapath = msg.datapath</span><br><span class="line">    dpid = datapath.<span class="built_in">id</span></span><br><span class="line">    recv_timestamp = time.time()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        src_dpid,src_port_no = LLDPPacket.lldp_parse(msg.data)</span><br><span class="line">        <span class="keyword">if</span> self.switches <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.switches = lookup_service_brick(<span class="string">&#x27;switches&#x27;</span>) </span><br><span class="line">        <span class="keyword">for</span> port <span class="keyword">in</span> self.switches.ports.keys():</span><br><span class="line">            <span class="keyword">if</span> src_dpid == port.dpid <span class="keyword">and</span> src_port_no == port.port_no:</span><br><span class="line">                self.lldp_delay[(src_dpid,dpid)] = self.switches.ports[port].delay</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        data = <span class="built_in">bytearray</span>(<span class="built_in">str</span>(time.time()),<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        echo_Req = parser.OFPEchoRequest(datapath,data=data)</span><br><span class="line">        datapath.send_msg(echo_Req)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@set_ev_cls(<span class="params">ofp_event.EventOFPEchoReply,[MAIN_DISPATCHER,CONFIG_DISPATCHER,HANDSHAKE_DISPATCHER]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo_rep_hander</span>(<span class="params">self,ev</span>):</span>        </span><br><span class="line">    recv_timestamp = time.time()</span><br><span class="line">    msg = ev.msg</span><br><span class="line">    datapath = msg.datapath</span><br><span class="line">    dpid = datapath.<span class="built_in">id</span></span><br><span class="line">    echo_delay = recv_timestamp - <span class="built_in">float</span>(msg.data.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    self.echo_delay[dpid] = echo_delay</span><br></pre></td></tr></table></figure></li>
<li><p>计算真实时延</p>
<p>在<code>install_path</code>中计算最短路径之前添加如下代码.计算公式如下</p>
<p>$delay = (lldp_delay_s12+lldp_delay_s21-echo_delay_s1-echo_delay_s2)/2$</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (src_id,dst_id) <span class="keyword">in</span> self.lldp_delay:</span><br><span class="line">            <span class="keyword">if</span> self.lldp_delay[(dst_id,src_id)] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> self.echo_delay[src_id] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.echo_delay[dst_id] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    self.delay[(src_id,dst_id)] = (self.lldp_delay[(src_id,dst_id)]+self.lldp_delay[(dst_id,src_id)]-self.echo_delay[src_id]-self.echo_delay[dst_id])/<span class="number">2</span></span><br></pre></td></tr></table></figure></li>
<li><p>计算最短时延路径</p>
<p>只需将原有的Dijkstra算法中的权值替换为节点之间的时延即可,代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">short_path</span>(<span class="params">self, src, dst</span>):</span></span><br><span class="line">    <span class="keyword">if</span> src == dst:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    result = defaultdict(<span class="keyword">lambda</span>: defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>))</span><br><span class="line">    distance = defaultdict(<span class="keyword">lambda</span>:<span class="literal">None</span>)</span><br><span class="line">    seen = [src]</span><br><span class="line">    distance[src] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(seen) &lt; <span class="built_in">len</span>(self.src_links):</span><br><span class="line">        node = seen[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> node == dst:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> (temp_src, temp_dst) <span class="keyword">in</span> self.src_links[node]:</span><br><span class="line">            <span class="keyword">if</span> temp_dst <span class="keyword">not</span> <span class="keyword">in</span> seen:</span><br><span class="line">                temp_src_port = self.src_links[node][(temp_src, temp_dst)][<span class="number">0</span>]</span><br><span class="line">                temp_dst_port = self.src_links[node][(temp_src, temp_dst)][<span class="number">1</span>]</span><br><span class="line">                <span class="keyword">if</span> (distance[temp_dst] <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> (distance[temp_dst] &gt; distance[temp_src] + self.delay[(temp_src,temp_dst)]):</span><br><span class="line">                    distance[temp_dst] = distance[temp_src] + self.delay[(temp_src,temp_dst)]</span><br><span class="line">                    result[temp_dst] = (temp_src, temp_src_port, temp_dst, temp_dst_port)</span><br><span class="line">        min_node = <span class="literal">None</span></span><br><span class="line">        min_path = <span class="number">999</span></span><br><span class="line">        <span class="keyword">for</span> temp_node <span class="keyword">in</span> distance:</span><br><span class="line">            <span class="keyword">if</span> (temp_node <span class="keyword">not</span> <span class="keyword">in</span> seen) <span class="keyword">and</span> (distance[temp_node] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">                <span class="keyword">if</span> distance[temp_node] &lt; min_path:</span><br><span class="line">                    min_node = temp_node</span><br><span class="line">                    min_path = distance[temp_node]</span><br><span class="line">        <span class="keyword">if</span> min_node <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        seen.append(min_node)</span><br><span class="line">    path = []</span><br><span class="line">    self.min_dist = distance[dst]</span><br><span class="line">    <span class="keyword">if</span> dst <span class="keyword">not</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> (dst <span class="keyword">in</span> result) <span class="keyword">and</span> (result[dst] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">        path = [result[dst][<span class="number">2</span>:<span class="number">4</span>]] + path</span><br><span class="line">        path = [result[dst][<span class="number">0</span>:<span class="number">2</span>]] + path</span><br><span class="line">        dst = result[dst][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> path</span><br></pre></td></tr></table></figure></li>
<li><p>实验结果</p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210528225118566.png" alt="image-20210528225118566"></p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210528225054584.png" alt="image-20210528225054584"></p>
</li>
</ul>
<h4 id="实验中的问题"><a href="#实验中的问题" class="headerlink" title="实验中的问题"></a>实验中的问题</h4><ul>
<li><p>网络拓扑程序中的时延不起作用</p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210529094622322.png" alt="image-20210529094622322"></p>
<p>原因是在<code>mn</code>命令中没有指定相应的参数,增加<code>--host cfs --link tc</code>即可,或者直接使用<code>sudo python2 Arpanet19723.py </code>运行.</p>
</li>
</ul>
<h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h4><h5 id="跳数最少"><a href="#跳数最少" class="headerlink" title="跳数最少"></a>跳数最少</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ryu.base <span class="keyword">import</span> app_manager</span><br><span class="line"><span class="keyword">from</span> ryu.controller <span class="keyword">import</span> ofp_event</span><br><span class="line"><span class="keyword">from</span> ryu.topology <span class="keyword">import</span> event</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> CONFIG_DISPATCHER, MAIN_DISPATCHER, DEAD_DISPATCHER, HANDSHAKE_DISPATCHER</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> set_ev_cls</span><br><span class="line"><span class="keyword">from</span> ryu.ofproto <span class="keyword">import</span> ofproto_v1_3</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> packet</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ethernet</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> arp</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ipv4</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> tcp</span><br><span class="line"><span class="keyword">from</span> ryu.topology.api <span class="keyword">import</span> get_link</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ether_types</span><br><span class="line"><span class="keyword">from</span> ryu.app.wsgi <span class="keyword">import</span>  WSGIApplication</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">import</span> network_monitor</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dynamic_rules</span>(<span class="params">app_manager.RyuApp</span>):</span></span><br><span class="line">    OFP_VERSIONS = [ofproto_v1_3.OFP_VERSION]</span><br><span class="line">    _CONTEXTS = &#123;</span><br><span class="line">        <span class="string">&quot;Network_Monitor&quot;</span>: network_monitor.Network_Monitor,</span><br><span class="line">        <span class="string">&quot;wsgi&quot;</span>: WSGIApplication</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(dynamic_rules, self).__init__(*args, **kwargs)</span><br><span class="line">        self.mac_to_port = &#123;&#125;</span><br><span class="line">        self.ip_to_mac = &#123;&#125;</span><br><span class="line">        self.mac_to_dpid = &#123;&#125;  <span class="comment"># &#123;mac:(dpid,port)&#125;</span></span><br><span class="line">        self.datapaths = defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>)</span><br><span class="line">        self.topology_api_app = self</span><br><span class="line">        self.src_links = defaultdict(<span class="keyword">lambda</span>: defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>))</span><br><span class="line">        self.check_ip_dpid = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">        self.qos_ip_bw_list = []</span><br><span class="line">        self.network_monitor = kwargs[<span class="string">&quot;Network_Monitor&quot;</span>]</span><br><span class="line">        self.ip_to_switch = &#123;&#125;</span><br><span class="line">        self.port_name_to_num = &#123;&#125;</span><br><span class="line">        self.ip_to_port = &#123;&#125;  <span class="comment">#&#123;ip:(dpid,port)&#125;</span></span><br><span class="line">        <span class="comment">#promise me, use it well :)</span></span><br><span class="line">        self.pathmod = <span class="number">0</span></span><br><span class="line">        self.path = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPSwitchFeatures, CONFIG_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">switch_features_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        datapath = ev.msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        match = parser.OFPMatch()</span><br><span class="line">        actions = [parser.OFPActionOutput(ofproto.OFPP_CONTROLLER,ofproto.OFPCML_NO_BUFFER)]</span><br><span class="line">        self.add_flow(datapath, <span class="number">0</span>, match, actions)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_flow</span>(<span class="params">self, datapath, priority, match, actions, buffer_id=<span class="literal">None</span>, idle_timeout=<span class="number">0</span>, hard_timeout=<span class="number">0</span></span>):</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line"></span><br><span class="line">        inst = [parser.OFPInstructionActions(ofproto.OFPIT_APPLY_ACTIONS,</span><br><span class="line">                                             actions)]</span><br><span class="line">        <span class="keyword">if</span> buffer_id:</span><br><span class="line">            mod = parser.OFPFlowMod(datapath=datapath, buffer_id=buffer_id,</span><br><span class="line">                                    priority=priority, match=match,</span><br><span class="line">                                    idle_timeout=idle_timeout,</span><br><span class="line">                                    hard_timeout=hard_timeout,</span><br><span class="line">                                    instructions=inst)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mod = parser.OFPFlowMod(datapath=datapath, priority=priority,</span><br><span class="line">                                    idle_timeout=idle_timeout,</span><br><span class="line">                                    hard_timeout=hard_timeout,</span><br><span class="line">                                    match=match, instructions=inst)</span><br><span class="line">        datapath.send_msg(mod)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPPacketIn, MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_packet_in_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        <span class="keyword">if</span> ev.msg.msg_len &lt; ev.msg.total_len:</span><br><span class="line">            self.logger.debug(<span class="string">&quot;packet truncated: only %s of %s bytes&quot;</span>,ev.msg.msg_len, ev.msg.total_len)</span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        in_port = msg.match[<span class="string">&#x27;in_port&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        pkt = packet.Packet(msg.data)</span><br><span class="line">        eth = pkt.get_protocols(ethernet.ethernet)[<span class="number">0</span>]</span><br><span class="line">        pkt_arp = pkt.get_protocol(arp.arp)</span><br><span class="line">        pkt_ipv4 = pkt.get_protocol(ipv4.ipv4)</span><br><span class="line">        pkt_tcp = pkt.get_protocol(tcp.tcp)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> eth.ethertype == ether_types.ETH_TYPE_LLDP:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        dst = eth.dst</span><br><span class="line">        src = eth.src</span><br><span class="line">        dpid = datapath.<span class="built_in">id</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># in rest_topology, self.mac_to_port is for the find for host</span></span><br><span class="line">        self.mac_to_port.setdefault(dpid, &#123;&#125;)</span><br><span class="line">        self.mac_to_port[dpid][src] = in_port</span><br><span class="line"></span><br><span class="line">        <span class="comment"># arp handle</span></span><br><span class="line">        <span class="keyword">if</span> pkt_arp <span class="keyword">and</span> pkt_arp.opcode == arp.ARP_REQUEST:</span><br><span class="line">            <span class="keyword">if</span> pkt_arp.src_ip <span class="keyword">not</span> <span class="keyword">in</span> self.ip_to_mac:</span><br><span class="line">                self.ip_to_mac[pkt_arp.src_ip] = src                                <span class="comment"># 主机ip地址和MAC地址的映射    IP：MAC</span></span><br><span class="line">                self.mac_to_dpid[src] = (dpid, in_port)                             <span class="comment"># 主机MAC地址和与主机相连的交换机的dpid的映射   MAC:(dpid,in_port)</span></span><br><span class="line">                self.ip_to_port[pkt_arp.src_ip] = (dpid, in_port)                   <span class="comment"># 主机IP地址和与主机相连的交换机的dpid的映射    IP:(dpid,in_port)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> pkt_arp.dst_ip <span class="keyword">in</span> self.ip_to_mac:                                    <span class="comment"># 查询的MAC地址已经学习过了</span></span><br><span class="line">                <span class="comment">#self.logger.info(&quot;[PACKET] ARP packet_in.&quot;)</span></span><br><span class="line">                self.handle_arpre(datapath=datapath, port=in_port,src_mac=self.ip_to_mac[pkt_arp.dst_ip],</span><br><span class="line">                                  dst_mac=src, src_ip=pkt_arp.dst_ip, dst_ip=pkt_arp.src_ip)</span><br><span class="line">            <span class="keyword">else</span>:                                                                   <span class="comment"># 查询的MAC地址没有被学习过</span></span><br><span class="line">                <span class="comment"># to avoid flood when the dst ip not in the network                 每个交换机对于一个ARP包只接收处理一次，重复的则丢弃</span></span><br><span class="line">                <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> self.check_ip_dpid[pkt_arp.dst_ip]:</span><br><span class="line">                    self.check_ip_dpid[pkt_arp.dst_ip].append(datapath.<span class="built_in">id</span>)          <span class="comment"># 目的主机IP地址和与收到ARP包的交换机的dpid    IP:dpid</span></span><br><span class="line">                    out_port = ofproto.OFPP_FLOOD</span><br><span class="line">                    actions = [parser.OFPActionOutput(out_port)]</span><br><span class="line">                    data = <span class="literal">None</span></span><br><span class="line">                    <span class="keyword">if</span> msg.buffer_id == ofproto.OFP_NO_BUFFER:</span><br><span class="line">                        data = msg.data</span><br><span class="line">                    out = parser.OFPPacketOut(datapath=datapath, buffer_id=msg.buffer_id,in_port=in_port, actions=actions, data=data)</span><br><span class="line">                    datapath.send_msg(out)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># ARP回复包直接转发到相应的交换机</span></span><br><span class="line">        <span class="keyword">elif</span> pkt_arp <span class="keyword">and</span> pkt_arp.opcode == arp.ARP_REPLY:</span><br><span class="line">            <span class="keyword">if</span> pkt_arp.src_ip <span class="keyword">not</span> <span class="keyword">in</span> self.ip_to_mac:</span><br><span class="line">                self.ip_to_mac[pkt_arp.src_ip] = src</span><br><span class="line">                self.mac_to_dpid[src] = (dpid, in_port)</span><br><span class="line">                self.ip_to_port[pkt_arp.src_ip] = (dpid, in_port)</span><br><span class="line">            dst_mac = self.ip_to_mac[pkt_arp.dst_ip]</span><br><span class="line">            (dst_dpid, dst_port) = self.mac_to_dpid[dst_mac]</span><br><span class="line">            self.handle_arpre(datapath=self.datapaths[dst_dpid], port=dst_port, src_mac=src, dst_mac=dst_mac,</span><br><span class="line">                              src_ip=pkt_arp.src_ip, dst_ip=pkt_arp.dst_ip)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pkt_ipv4 <span class="keyword">and</span> (self.ip_to_port.get(pkt_ipv4.dst)) <span class="keyword">and</span> (self.ip_to_port.get(pkt_ipv4.src)):</span><br><span class="line">            (src_dpid, src_port) = self.ip_to_port[pkt_ipv4.src]  <span class="comment"># src dpid and port</span></span><br><span class="line">            (dst_dpid, dst_port) = self.ip_to_port[pkt_ipv4.dst]  <span class="comment"># dst dpid and port</span></span><br><span class="line">            self.install_path(src_dpid=src_dpid, dst_dpid=dst_dpid, src_port=src_port, dst_port=dst_port,</span><br><span class="line">                              ev=ev, src=src, dst=dst, pkt_ipv4=pkt_ipv4, pkt_tcp=pkt_tcp)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;path:%s -&gt; %s&quot;</span> %(pkt_ipv4.src,pkt_ipv4.dst))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;%s -&gt; &quot;</span> %pkt_ipv4.src,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(self.path),<span class="number">2</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;%d:&quot;</span> %self.path[i][<span class="number">1</span>],end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;s%d&quot;</span> %self.path[i][<span class="number">0</span>],end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;:%d -&gt; &quot;</span> %self.path[i+<span class="number">1</span>][<span class="number">1</span>],end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;%s&quot;</span> %pkt_ipv4.dst)</span><br><span class="line">    <span class="comment"># 将pkt报文通过datapath对应的交换机的port端口转发出去</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_pkt</span>(<span class="params">self, datapath, port, pkt</span>):</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        pkt.serialize()</span><br><span class="line">        data = pkt.data</span><br><span class="line">        actions = [parser.OFPActionOutput(port=port)]</span><br><span class="line">        out = parser.OFPPacketOut(datapath=datapath, buffer_id=ofproto.OFP_NO_BUFFER, in_port=ofproto.OFPP_CONTROLLER,</span><br><span class="line">                                  actions=actions, data=data)</span><br><span class="line">        datapath.send_msg(out)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造ARP应答报文并发送给相应的主机</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_arpre</span>(<span class="params">self, datapath, port, src_mac, dst_mac, src_ip, dst_ip</span>):</span></span><br><span class="line">        pkt = packet.Packet()</span><br><span class="line">        pkt.add_protocol(ethernet.ethernet(ethertype=<span class="number">0x0806</span>, dst=dst_mac, src=src_mac))</span><br><span class="line">        pkt.add_protocol(arp.arp(opcode=arp.ARP_REPLY, src_mac=src_mac, src_ip=src_ip, dst_mac=dst_mac, dst_ip=dst_ip))</span><br><span class="line">        self.send_pkt(datapath, port, pkt)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_path</span>(<span class="params">self, src_dpid, dst_dpid, src_port, dst_port, ev, src, dst, pkt_ipv4, pkt_tcp</span>):</span></span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">       </span><br><span class="line">        mid_path = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        mid_path = self.short_path(src=src_dpid, dst=dst_dpid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mid_path <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.path = <span class="literal">None</span></span><br><span class="line">        self.path = [(src_dpid, src_port)] + mid_path + [(dst_dpid, dst_port)]</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.path) - <span class="number">2</span>, -<span class="number">1</span>, -<span class="number">2</span>):</span><br><span class="line">            datapath_path = self.datapaths[self.path[i][<span class="number">0</span>]]</span><br><span class="line">            match = parser.OFPMatch(in_port=self.path[i][<span class="number">1</span>], eth_src=src, eth_dst=dst, eth_type=<span class="number">0x0800</span>,</span><br><span class="line">                                    ipv4_src=pkt_ipv4.src, ipv4_dst=pkt_ipv4.dst)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> i &lt; (<span class="built_in">len</span>(self.path) - <span class="number">2</span>):</span><br><span class="line">                actions = [parser.OFPActionOutput(self.path[i + <span class="number">1</span>][<span class="number">1</span>])]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                actions = [parser.OFPActionSetField(eth_dst=self.ip_to_mac.get(pkt_ipv4.dst)),</span><br><span class="line">                            parser.OFPActionOutput(self.path[i + <span class="number">1</span>][<span class="number">1</span>])]</span><br><span class="line">            </span><br><span class="line">            self.add_flow(datapath_path, <span class="number">100</span>, match, actions, idle_timeout=<span class="number">0</span>, hard_timeout=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">short_path</span>(<span class="params">self, src, dst, bw=<span class="number">0</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> src == dst:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        result = defaultdict(<span class="keyword">lambda</span>: defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>))</span><br><span class="line">        distance = defaultdict(<span class="keyword">lambda</span>:<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># the node is checked</span></span><br><span class="line">        seen = [src]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># the distance to src</span></span><br><span class="line">        distance[src] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        w = <span class="number">1</span>  <span class="comment"># weight</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(seen) &lt; <span class="built_in">len</span>(self.src_links):</span><br><span class="line">            node = seen[-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> node == dst:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">for</span> (temp_src, temp_dst) <span class="keyword">in</span> self.src_links[node]:</span><br><span class="line">                <span class="keyword">if</span> temp_dst <span class="keyword">not</span> <span class="keyword">in</span> seen:</span><br><span class="line">                    temp_src_port = self.src_links[node][(temp_src, temp_dst)][<span class="number">0</span>]</span><br><span class="line">                    temp_dst_port = self.src_links[node][(temp_src, temp_dst)][<span class="number">1</span>]</span><br><span class="line">                    <span class="keyword">if</span> (distance[temp_dst] <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> (distance[temp_dst] &gt; distance[temp_src] + w):</span><br><span class="line">                        distance[temp_dst] = distance[temp_src] + w</span><br><span class="line">                        <span class="comment"># result = &#123;&quot;dpid&quot;:(link_src, src_port, link_dst, dst_port)&#125;</span></span><br><span class="line">                        result[temp_dst] = (temp_src, temp_src_port, temp_dst, temp_dst_port)</span><br><span class="line">            min_node = <span class="literal">None</span></span><br><span class="line">            min_path = <span class="number">999</span></span><br><span class="line">            <span class="comment"># get the min_path node</span></span><br><span class="line">            <span class="keyword">for</span> temp_node <span class="keyword">in</span> distance:</span><br><span class="line">                <span class="keyword">if</span> (temp_node <span class="keyword">not</span> <span class="keyword">in</span> seen) <span class="keyword">and</span> (distance[temp_node] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">                    <span class="keyword">if</span> distance[temp_node] &lt; min_path:</span><br><span class="line">                        min_node = temp_node</span><br><span class="line">                        min_path = distance[temp_node]</span><br><span class="line">            <span class="keyword">if</span> min_node <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            seen.append(min_node)</span><br><span class="line"></span><br><span class="line">        path = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> dst <span class="keyword">not</span> <span class="keyword">in</span> result:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (dst <span class="keyword">in</span> result) <span class="keyword">and</span> (result[dst] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">            path = [result[dst][<span class="number">2</span>:<span class="number">4</span>]] + path</span><br><span class="line">            path = [result[dst][<span class="number">0</span>:<span class="number">2</span>]] + path</span><br><span class="line">            dst = result[dst][<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPStateChange, [MAIN_DISPATCHER, DEAD_DISPATCHER]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">state_change_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        datapath = ev.datapath</span><br><span class="line">        <span class="keyword">if</span> ev.state == MAIN_DISPATCHER:</span><br><span class="line">            <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> self.datapaths:</span><br><span class="line">                self.datapaths[datapath.<span class="built_in">id</span>] = datapath</span><br><span class="line">        <span class="keyword">elif</span> ev.state == DEAD_DISPATCHER:</span><br><span class="line">            <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">in</span> self.datapaths:</span><br><span class="line">                <span class="keyword">del</span> self.datapaths[datapath.<span class="built_in">id</span>]</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">[event.EventSwitchEnter, event.EventSwitchLeave, event.EventPortAdd, event.EventPortDelete,</span></span></span><br><span class="line"><span class="params"><span class="meta">        event.EventPortModify, event.EventLinkAdd, event.EventLinkDelete]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_topology</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        links_list = get_link(self.topology_api_app, <span class="literal">None</span>)</span><br><span class="line">        self.src_links.clear()</span><br><span class="line">        <span class="keyword">for</span> link <span class="keyword">in</span> links_list:</span><br><span class="line">            sw_src = link.src.dpid</span><br><span class="line">            sw_dst = link.dst.dpid</span><br><span class="line">            src_port = link.src.port_no</span><br><span class="line">            dst_port = link.dst.port_no</span><br><span class="line">            src_port_name = link.src.name</span><br><span class="line">            dst_port_name = link.dst.name</span><br><span class="line">            self.port_name_to_num[src_port_name] = src_port</span><br><span class="line">            self.port_name_to_num[dst_port_name] = dst_port</span><br><span class="line">            self.src_links[sw_src][(sw_src, sw_dst)] = (src_port, dst_port)</span><br><span class="line">            self.src_links[sw_dst][(sw_dst, sw_src)] = (dst_port, src_port)</span><br></pre></td></tr></table></figure>

<h5 id="时延最小"><a href="#时延最小" class="headerlink" title="时延最小"></a>时延最小</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ryu.base <span class="keyword">import</span> app_manager</span><br><span class="line"><span class="keyword">from</span> ryu.controller <span class="keyword">import</span> ofp_event</span><br><span class="line"><span class="keyword">from</span> ryu.topology <span class="keyword">import</span> event</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> CONFIG_DISPATCHER, MAIN_DISPATCHER, DEAD_DISPATCHER, HANDSHAKE_DISPATCHER</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> set_ev_cls</span><br><span class="line"><span class="keyword">from</span> ryu.ofproto <span class="keyword">import</span> ofproto_v1_3</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> packet</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ethernet</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> arp</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ipv4</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> tcp</span><br><span class="line"><span class="keyword">from</span> ryu.topology.api <span class="keyword">import</span> get_link</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ether_types</span><br><span class="line"><span class="keyword">from</span> ryu.app.wsgi <span class="keyword">import</span>  WSGIApplication</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">from</span> ryu.base.app_manager <span class="keyword">import</span> lookup_service_brick</span><br><span class="line"><span class="keyword">from</span> ryu.topology.switches <span class="keyword">import</span> LLDPPacket</span><br><span class="line"><span class="keyword">import</span> network_monitor</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dynamic_rules</span>(<span class="params">app_manager.RyuApp</span>):</span></span><br><span class="line">    OFP_VERSIONS = [ofproto_v1_3.OFP_VERSION]</span><br><span class="line">    _CONTEXTS = &#123;</span><br><span class="line">        <span class="string">&quot;Network_Monitor&quot;</span>: network_monitor.Network_Monitor,</span><br><span class="line">        <span class="string">&quot;wsgi&quot;</span>: WSGIApplication</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(dynamic_rules, self).__init__(*args, **kwargs)</span><br><span class="line">        self.mac_to_port = &#123;&#125;</span><br><span class="line">        self.ip_to_mac = &#123;&#125;</span><br><span class="line">        self.mac_to_dpid = &#123;&#125;  <span class="comment"># &#123;mac:(dpid,port)&#125;</span></span><br><span class="line">        self.datapaths = defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>)</span><br><span class="line">        self.topology_api_app = self</span><br><span class="line">        self.src_links = defaultdict(<span class="keyword">lambda</span>: defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>))</span><br><span class="line">        self.check_ip_dpid = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">        self.qos_ip_bw_list = []</span><br><span class="line">        self.network_monitor = kwargs[<span class="string">&quot;Network_Monitor&quot;</span>]     </span><br><span class="line">        self.ip_to_switch = &#123;&#125;</span><br><span class="line">        self.port_name_to_num = &#123;&#125;</span><br><span class="line">        self.ip_to_port = &#123;&#125;  <span class="comment">#&#123;ip:(dpid,port)&#125;</span></span><br><span class="line">        <span class="comment">#promise me, use it well :)</span></span><br><span class="line">        self.pathmod = <span class="number">0</span></span><br><span class="line">        self.path = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self.lldp_delay = defaultdict(<span class="keyword">lambda</span>:<span class="literal">None</span>)          <span class="comment"># &#123;(src_dpid,dst_dpid):lldp_delay&#125;</span></span><br><span class="line">        self.echo_delay = defaultdict(<span class="keyword">lambda</span>:<span class="literal">None</span>)          <span class="comment"># &#123;dpid:echo_delay&#125;</span></span><br><span class="line">        self.delay = defaultdict(<span class="keyword">lambda</span>:<span class="literal">None</span>)               <span class="comment"># &#123;(scr_dpid,dst_dpid):delay&#125;</span></span><br><span class="line">        self.switches = <span class="literal">None</span></span><br><span class="line">        self.min_dist = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPSwitchFeatures, CONFIG_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">switch_features_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        datapath = ev.msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        match = parser.OFPMatch()</span><br><span class="line">        actions = [parser.OFPActionOutput(ofproto.OFPP_CONTROLLER,ofproto.OFPCML_NO_BUFFER)]</span><br><span class="line">        self.add_flow(datapath, <span class="number">0</span>, match, actions)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_flow</span>(<span class="params">self, datapath, priority, match, actions, buffer_id=<span class="literal">None</span>, idle_timeout=<span class="number">0</span>, hard_timeout=<span class="number">0</span></span>):</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line"></span><br><span class="line">        inst = [parser.OFPInstructionActions(ofproto.OFPIT_APPLY_ACTIONS,</span><br><span class="line">                                             actions)]</span><br><span class="line">        <span class="keyword">if</span> buffer_id:</span><br><span class="line">            mod = parser.OFPFlowMod(datapath=datapath, buffer_id=buffer_id,</span><br><span class="line">                                    priority=priority, match=match,</span><br><span class="line">                                    idle_timeout=idle_timeout,</span><br><span class="line">                                    hard_timeout=hard_timeout,</span><br><span class="line">                                    instructions=inst)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mod = parser.OFPFlowMod(datapath=datapath, priority=priority,</span><br><span class="line">                                    idle_timeout=idle_timeout,</span><br><span class="line">                                    hard_timeout=hard_timeout,</span><br><span class="line">                                    match=match, instructions=inst)</span><br><span class="line">        datapath.send_msg(mod)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPPacketIn, MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_packet_in_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        <span class="keyword">if</span> ev.msg.msg_len &lt; ev.msg.total_len:</span><br><span class="line">            self.logger.debug(<span class="string">&quot;packet truncated: only %s of %s bytes&quot;</span>,ev.msg.msg_len, ev.msg.total_len)</span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        in_port = msg.match[<span class="string">&#x27;in_port&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        pkt = packet.Packet(msg.data)</span><br><span class="line">        eth = pkt.get_protocols(ethernet.ethernet)[<span class="number">0</span>]</span><br><span class="line">        pkt_arp = pkt.get_protocol(arp.arp)</span><br><span class="line">        pkt_ipv4 = pkt.get_protocol(ipv4.ipv4)</span><br><span class="line">        pkt_tcp = pkt.get_protocol(tcp.tcp)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> eth.ethertype == ether_types.ETH_TYPE_LLDP:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        dst = eth.dst</span><br><span class="line">        src = eth.src</span><br><span class="line">        dpid = datapath.<span class="built_in">id</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># in rest_topology, self.mac_to_port is for the find for host</span></span><br><span class="line">        self.mac_to_port.setdefault(dpid, &#123;&#125;)</span><br><span class="line">        self.mac_to_port[dpid][src] = in_port</span><br><span class="line"></span><br><span class="line">        <span class="comment"># arp handle</span></span><br><span class="line">        <span class="keyword">if</span> pkt_arp <span class="keyword">and</span> pkt_arp.opcode == arp.ARP_REQUEST:</span><br><span class="line">            <span class="keyword">if</span> pkt_arp.src_ip <span class="keyword">not</span> <span class="keyword">in</span> self.ip_to_mac:</span><br><span class="line">                self.ip_to_mac[pkt_arp.src_ip] = src                                <span class="comment"># 主机ip地址和MAC地址的映射    IP：MAC</span></span><br><span class="line">                self.mac_to_dpid[src] = (dpid, in_port)                             <span class="comment"># 主机MAC地址和与主机相连的交换机的dpid的映射   MAC:(dpid,in_port)</span></span><br><span class="line">                self.ip_to_port[pkt_arp.src_ip] = (dpid, in_port)                   <span class="comment"># 主机IP地址和与主机相连的交换机的dpid的映射    IP:(dpid,in_port)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> pkt_arp.dst_ip <span class="keyword">in</span> self.ip_to_mac:                                    <span class="comment"># 查询的MAC地址已经学习过了</span></span><br><span class="line">                self.handle_arpre(datapath=datapath, port=in_port,src_mac=self.ip_to_mac[pkt_arp.dst_ip],</span><br><span class="line">                                  dst_mac=src, src_ip=pkt_arp.dst_ip, dst_ip=pkt_arp.src_ip)</span><br><span class="line">            <span class="keyword">else</span>:                                                                   <span class="comment"># 查询的MAC地址没有被学习过</span></span><br><span class="line">                <span class="comment"># to avoid flood when the dst ip not in the network                 每个交换机对于一个ARP包只接收处理一次，重复的则丢弃</span></span><br><span class="line">                <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> self.check_ip_dpid[pkt_arp.dst_ip]:</span><br><span class="line">                    self.check_ip_dpid[pkt_arp.dst_ip].append(datapath.<span class="built_in">id</span>)          <span class="comment"># 目的主机IP地址和与收到ARP包的交换机的dpid    IP:dpid</span></span><br><span class="line">                    out_port = ofproto.OFPP_FLOOD</span><br><span class="line">                    actions = [parser.OFPActionOutput(out_port)]</span><br><span class="line">                    data = <span class="literal">None</span></span><br><span class="line">                    <span class="keyword">if</span> msg.buffer_id == ofproto.OFP_NO_BUFFER:</span><br><span class="line">                        data = msg.data</span><br><span class="line">                    out = parser.OFPPacketOut(datapath=datapath, buffer_id=msg.buffer_id,in_port=in_port, actions=actions, data=data)</span><br><span class="line">                    datapath.send_msg(out)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># ARP回复包直接转发到相应的交换机</span></span><br><span class="line">        <span class="keyword">elif</span> pkt_arp <span class="keyword">and</span> pkt_arp.opcode == arp.ARP_REPLY:</span><br><span class="line">            <span class="keyword">if</span> pkt_arp.src_ip <span class="keyword">not</span> <span class="keyword">in</span> self.ip_to_mac:</span><br><span class="line">                self.ip_to_mac[pkt_arp.src_ip] = src</span><br><span class="line">                self.mac_to_dpid[src] = (dpid, in_port)</span><br><span class="line">                self.ip_to_port[pkt_arp.src_ip] = (dpid, in_port)</span><br><span class="line">            dst_mac = self.ip_to_mac[pkt_arp.dst_ip]</span><br><span class="line">            (dst_dpid, dst_port) = self.mac_to_dpid[dst_mac]</span><br><span class="line">            self.handle_arpre(datapath=self.datapaths[dst_dpid], port=dst_port, src_mac=src, dst_mac=dst_mac,</span><br><span class="line">                              src_ip=pkt_arp.src_ip, dst_ip=pkt_arp.dst_ip)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pkt_ipv4 <span class="keyword">and</span> (self.ip_to_port.get(pkt_ipv4.dst)) <span class="keyword">and</span> (self.ip_to_port.get(pkt_ipv4.src)):</span><br><span class="line">            (src_dpid, src_port) = self.ip_to_port[pkt_ipv4.src]  <span class="comment"># src dpid and port</span></span><br><span class="line">            (dst_dpid, dst_port) = self.ip_to_port[pkt_ipv4.dst]  <span class="comment"># dst dpid and port</span></span><br><span class="line">            self.install_path(src_dpid=src_dpid, dst_dpid=dst_dpid, src_port=src_port, dst_port=dst_port,</span><br><span class="line">                              ev=ev, src=src, dst=dst, pkt_ipv4=pkt_ipv4, pkt_tcp=pkt_tcp)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;path:%s -&gt; %s&quot;</span> %(pkt_ipv4.src,pkt_ipv4.dst))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;%s -&gt; &quot;</span> %pkt_ipv4.src,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(self.path),<span class="number">2</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;%d:&quot;</span> %self.path[i][<span class="number">1</span>],end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;s%d&quot;</span> %self.path[i][<span class="number">0</span>],end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;:%d -&gt; &quot;</span> %self.path[i+<span class="number">1</span>][<span class="number">1</span>],end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;%s&quot;</span> %pkt_ipv4.dst)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;总时延: %dms&quot;</span> %(self.min_dist*<span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将pkt报文通过datapath对应的交换机的port端口转发出去</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_pkt</span>(<span class="params">self, datapath, port, pkt</span>):</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        pkt.serialize()</span><br><span class="line">        data = pkt.data</span><br><span class="line">        actions = [parser.OFPActionOutput(port=port)]</span><br><span class="line">        out = parser.OFPPacketOut(datapath=datapath, buffer_id=ofproto.OFP_NO_BUFFER, in_port=ofproto.OFPP_CONTROLLER,</span><br><span class="line">                                  actions=actions, data=data)</span><br><span class="line">        datapath.send_msg(out)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造ARP应答报文并发送给相应的主机</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_arpre</span>(<span class="params">self, datapath, port, src_mac, dst_mac, src_ip, dst_ip</span>):</span></span><br><span class="line">        pkt = packet.Packet()</span><br><span class="line">        pkt.add_protocol(ethernet.ethernet(ethertype=<span class="number">0x0806</span>, dst=dst_mac, src=src_mac))</span><br><span class="line">        pkt.add_protocol(arp.arp(opcode=arp.ARP_REPLY, src_mac=src_mac, src_ip=src_ip, dst_mac=dst_mac, dst_ip=dst_ip))</span><br><span class="line">        self.send_pkt(datapath, port, pkt)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_path</span>(<span class="params">self, src_dpid, dst_dpid, src_port, dst_port, ev, src, dst, pkt_ipv4, pkt_tcp</span>):</span></span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        <span class="comment"># print(&quot;src: %d , dst: %d&quot; %(src_dpid,dst_dpid))</span></span><br><span class="line">        mid_path = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 计算时延      </span></span><br><span class="line">        <span class="keyword">for</span> (src_id,dst_id) <span class="keyword">in</span> self.lldp_delay:</span><br><span class="line">            <span class="keyword">if</span> self.lldp_delay[(dst_id,src_id)] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> self.echo_delay[src_id] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.echo_delay[dst_id] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    self.delay[(src_id,dst_id)] = (self.lldp_delay[(src_id,dst_id)]+self.lldp_delay[(dst_id,src_id)]-self.echo_delay[src_id]-self.echo_delay[dst_id])/<span class="number">2</span></span><br><span class="line">        </span><br><span class="line">        mid_path = self.short_path(src=src_dpid, dst=dst_dpid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mid_path <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.path = <span class="literal">None</span></span><br><span class="line">        self.path = [(src_dpid, src_port)] + mid_path + [(dst_dpid, dst_port)]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.path) - <span class="number">2</span>, -<span class="number">1</span>, -<span class="number">2</span>):</span><br><span class="line">            datapath_path = self.datapaths[self.path[i][<span class="number">0</span>]]</span><br><span class="line">            match = parser.OFPMatch(in_port=self.path[i][<span class="number">1</span>], eth_src=src, eth_dst=dst, eth_type=<span class="number">0x0800</span>,</span><br><span class="line">                                    ipv4_src=pkt_ipv4.src, ipv4_dst=pkt_ipv4.dst)</span><br><span class="line">            <span class="keyword">if</span> i &lt; (<span class="built_in">len</span>(self.path) - <span class="number">2</span>):</span><br><span class="line">                actions = [parser.OFPActionOutput(self.path[i + <span class="number">1</span>][<span class="number">1</span>])]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                actions = [parser.OFPActionSetField(eth_dst=self.ip_to_mac.get(pkt_ipv4.dst)),</span><br><span class="line">                            parser.OFPActionOutput(self.path[i + <span class="number">1</span>][<span class="number">1</span>])]</span><br><span class="line">            self.add_flow(datapath_path, <span class="number">100</span>, match, actions, idle_timeout=<span class="number">0</span>, hard_timeout=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">short_path</span>(<span class="params">self, src, dst</span>):</span></span><br><span class="line">        <span class="keyword">if</span> src == dst:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        result = defaultdict(<span class="keyword">lambda</span>: defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>))</span><br><span class="line">        distance = defaultdict(<span class="keyword">lambda</span>:<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># the node is checked</span></span><br><span class="line">        seen = [src]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># the distance to src</span></span><br><span class="line">        distance[src] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(seen) &lt; <span class="built_in">len</span>(self.src_links):</span><br><span class="line">            node = seen[-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> node == dst:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">for</span> (temp_src, temp_dst) <span class="keyword">in</span> self.src_links[node]:</span><br><span class="line">                <span class="keyword">if</span> temp_dst <span class="keyword">not</span> <span class="keyword">in</span> seen:</span><br><span class="line">                    temp_src_port = self.src_links[node][(temp_src, temp_dst)][<span class="number">0</span>]</span><br><span class="line">                    temp_dst_port = self.src_links[node][(temp_src, temp_dst)][<span class="number">1</span>]</span><br><span class="line">                    <span class="keyword">if</span> (distance[temp_dst] <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> (distance[temp_dst] &gt; distance[temp_src] + self.delay[(temp_src,temp_dst)]):</span><br><span class="line">                        distance[temp_dst] = distance[temp_src] + self.delay[(temp_src,temp_dst)]</span><br><span class="line">                        <span class="comment"># result = &#123;&quot;dpid&quot;:(link_src, src_port, link_dst, dst_port)&#125;</span></span><br><span class="line">                        result[temp_dst] = (temp_src, temp_src_port, temp_dst, temp_dst_port)</span><br><span class="line">            min_node = <span class="literal">None</span></span><br><span class="line">            min_path = <span class="number">999</span></span><br><span class="line">            <span class="comment"># get the min_path node</span></span><br><span class="line">            <span class="keyword">for</span> temp_node <span class="keyword">in</span> distance:</span><br><span class="line">                <span class="keyword">if</span> (temp_node <span class="keyword">not</span> <span class="keyword">in</span> seen) <span class="keyword">and</span> (distance[temp_node] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">                    <span class="keyword">if</span> distance[temp_node] &lt; min_path:</span><br><span class="line">                        min_node = temp_node</span><br><span class="line">                        min_path = distance[temp_node]</span><br><span class="line">            <span class="keyword">if</span> min_node <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            seen.append(min_node)</span><br><span class="line"></span><br><span class="line">        path = []</span><br><span class="line">        self.min_dist = distance[dst]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> dst <span class="keyword">not</span> <span class="keyword">in</span> result:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (dst <span class="keyword">in</span> result) <span class="keyword">and</span> (result[dst] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">            path = [result[dst][<span class="number">2</span>:<span class="number">4</span>]] + path</span><br><span class="line">            path = [result[dst][<span class="number">0</span>:<span class="number">2</span>]] + path</span><br><span class="line">            dst = result[dst][<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPStateChange, [MAIN_DISPATCHER, DEAD_DISPATCHER]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">state_change_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        datapath = ev.datapath</span><br><span class="line">        <span class="keyword">if</span> ev.state == MAIN_DISPATCHER:</span><br><span class="line">            <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> self.datapaths:</span><br><span class="line">                self.datapaths[datapath.<span class="built_in">id</span>] = datapath</span><br><span class="line">        <span class="keyword">elif</span> ev.state == DEAD_DISPATCHER:</span><br><span class="line">            <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">in</span> self.datapaths:</span><br><span class="line">                <span class="keyword">del</span> self.datapaths[datapath.<span class="built_in">id</span>]</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">[event.EventSwitchEnter, event.EventSwitchLeave, event.EventPortAdd, event.EventPortDelete,</span></span></span><br><span class="line"><span class="params"><span class="meta">        event.EventPortModify, event.EventLinkAdd, event.EventLinkDelete]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_topology</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        links_list = get_link(self.topology_api_app, <span class="literal">None</span>)</span><br><span class="line">        self.src_links.clear()</span><br><span class="line">        <span class="keyword">for</span> link <span class="keyword">in</span> links_list:</span><br><span class="line">            sw_src = link.src.dpid</span><br><span class="line">            sw_dst = link.dst.dpid</span><br><span class="line">            src_port = link.src.port_no</span><br><span class="line">            dst_port = link.dst.port_no</span><br><span class="line">            src_port_name = link.src.name</span><br><span class="line">            dst_port_name = link.dst.name</span><br><span class="line">            self.port_name_to_num[src_port_name] = src_port</span><br><span class="line">            self.port_name_to_num[dst_port_name] = dst_port</span><br><span class="line">            self.src_links[sw_src][(sw_src, sw_dst)] = (src_port, dst_port)</span><br><span class="line">            self.src_links[sw_dst][(sw_dst, sw_src)] = (dst_port, src_port)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPPacketIn,MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">packet_in_hander</span>(<span class="params">self,ev</span>):</span></span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        dpid = datapath.<span class="built_in">id</span></span><br><span class="line">        recv_timestamp = time.time()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            src_dpid,src_port_no = LLDPPacket.lldp_parse(msg.data)</span><br><span class="line">            <span class="comment"># print(&quot;LLDP: &quot;,end=&#x27;&#x27;)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.switches <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                self.switches = lookup_service_brick(<span class="string">&#x27;switches&#x27;</span>) </span><br><span class="line">            <span class="keyword">for</span> port <span class="keyword">in</span> self.switches.ports.keys():</span><br><span class="line">                <span class="keyword">if</span> src_dpid == port.dpid <span class="keyword">and</span> src_port_no == port.port_no:</span><br><span class="line">                    self.lldp_delay[(src_dpid,dpid)] = self.switches.ports[port].delay</span><br><span class="line">            parser = datapath.ofproto_parser</span><br><span class="line">            data = <span class="built_in">bytearray</span>(<span class="built_in">str</span>(time.time()),<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">            echo_Req = parser.OFPEchoRequest(datapath,data=data)</span><br><span class="line">            datapath.send_msg(echo_Req)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPEchoReply,[MAIN_DISPATCHER,CONFIG_DISPATCHER,HANDSHAKE_DISPATCHER]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">echo_rep_hander</span>(<span class="params">self,ev</span>):</span>        </span><br><span class="line">        recv_timestamp = time.time()</span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        dpid = datapath.<span class="built_in">id</span></span><br><span class="line">        echo_delay = recv_timestamp - <span class="built_in">float</span>(msg.data.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        self.echo_delay[dpid] = echo_delay</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/17/Note/%E7%AC%94%E8%AE%B0/%E5%AE%9E%E9%AA%8C/SDN%E5%AE%9E%E9%AA%8C/%E5%AE%9E%E9%AA%8C%E4%BA%8CREADME/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱辉">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuhui's yard">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/17/Note/%E7%AC%94%E8%AE%B0/%E5%AE%9E%E9%AA%8C/SDN%E5%AE%9E%E9%AA%8C/%E5%AE%9E%E9%AA%8C%E4%BA%8CREADME/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-17 21:04:46" itemprop="dateCreated datePublished" datetime="2021-07-17T21:04:46+08:00">2021-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-02 22:05:52" itemprop="dateModified" datetime="2021-07-02T22:05:52+08:00">2021-07-02</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>24 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="实验二"><a href="#实验二" class="headerlink" title="实验二"></a>实验二</h3><h4 id="在mininet上建立网络"><a href="#在mininet上建立网络" class="headerlink" title="在mininet上建立网络"></a>在mininet上建立网络</h4><ul>
<li><p>拓扑图如下</p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210515162558640.png" alt="image-20210515162558640"></p>
</li>
<li><p>实现代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mininet.topo <span class="keyword">import</span> Topo</span><br><span class="line"><span class="keyword">from</span> mininet.net <span class="keyword">import</span> Mininet</span><br><span class="line"><span class="keyword">from</span> mininet.util <span class="keyword">import</span> dumpNodeConnections</span><br><span class="line"><span class="keyword">from</span> mininet.log <span class="keyword">import</span> setLogLevel</span><br><span class="line"><span class="keyword">from</span> mininet.cli <span class="keyword">import</span> CLI</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exp3</span>(<span class="params">Topo</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build</span>(<span class="params">self</span>):</span></span><br><span class="line">        h1 = self.addHost(<span class="string">&#x27;h1&#x27;</span>)</span><br><span class="line">        h2 = self.addHost(<span class="string">&#x27;h2&#x27;</span>)</span><br><span class="line">        s1 = self.addSwitch(<span class="string">&#x27;s1&#x27;</span>)</span><br><span class="line">        s2 = self.addSwitch(<span class="string">&#x27;s2&#x27;</span>)</span><br><span class="line">        s3 = self.addSwitch(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">        s4 = self.addSwitch(<span class="string">&#x27;s4&#x27;</span>)</span><br><span class="line">        s5 = self.addSwitch(<span class="string">&#x27;s5&#x27;</span>)</span><br><span class="line">        self.addLink(h1,s1)</span><br><span class="line">        self.addLink(h2,s5)</span><br><span class="line">        self.addLink(s1,s2)</span><br><span class="line">        self.addLink(s1,s4)</span><br><span class="line">        self.addLink(s2,s3)</span><br><span class="line">        self.addLink(s3,s5)</span><br><span class="line">        self.addLink(s4,s5)</span><br><span class="line"></span><br><span class="line">topos = &#123;<span class="string">&#x27;mytopo&#x27;</span>:exp3&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mn --custom topo.py --topo mytopo --controller=remote</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="动态改变转发规则"><a href="#动态改变转发规则" class="headerlink" title="动态改变转发规则"></a>动态改变转发规则</h4><ul>
<li><p>求最长路径</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">long_path</span>(<span class="params">self, src, dst</span>):</span></span><br><span class="line">        path1 = [(<span class="number">1</span>,<span class="number">2</span>),(<span class="number">2</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">1</span>),(<span class="number">3</span>,<span class="number">2</span>),(<span class="number">5</span>,<span class="number">2</span>)]</span><br><span class="line">        path2 = [(<span class="number">5</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">2</span>),(<span class="number">2</span>,<span class="number">1</span>),(<span class="number">1</span>,<span class="number">2</span>)]</span><br><span class="line">        <span class="keyword">if</span> src == path1[<span class="number">0</span>][<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">return</span> path1</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> path2</span><br></pre></td></tr></table></figure>

<p>由于此拓扑路径比较简单，且dijkstra算法无法求最长路径，此处直接给出最长路径。</p>
</li>
<li><p>更改<code>install_path</code>函数中<code>add_flow</code>函数的<code>hard_timeout</code>参数,即为修改安装到交换机的流表的硬超时时间,当安装的流表超出此时间后会被无条件删除。实验中将此参数设置为5，实现每5秒切换一次路径</p>
</li>
<li><p>路径选择</p>
<p>在<code>install_path</code>安装路径前添加如下代码用于判断使用最长还是最短路径</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.src != src_dpid:</span><br><span class="line">    self.i += <span class="number">1</span></span><br><span class="line">    self.src = src_dpid</span><br><span class="line"><span class="keyword">if</span> self.i == <span class="number">3</span>:</span><br><span class="line">    self.flag  = <span class="number">1</span> - self.flag   </span><br><span class="line">    self.i = <span class="number">1</span>    </span><br><span class="line"><span class="keyword">if</span>(self.flag == <span class="number">0</span>):      <span class="comment"># 最短路径</span></span><br><span class="line">    mid_path = self.short_path(src=src_dpid, dst=dst_dpid, w=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  	mid_path = self.long_path(src=src_dpid,dst=dst_dpid)</span><br></pre></td></tr></table></figure>

<p>基本思想为记录每次的源交换机的dpid,下一次调用此函数时进行比较,如果dpid已经发生了两次变化,则第三次变化时修改计算路径的方式(最长或者最短)。</p>
</li>
<li><p>运行结果</p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210517103530479.png" alt="image-20210517103530479"></p>
</li>
</ul>
<h4 id="链路故障恢复功能"><a href="#链路故障恢复功能" class="headerlink" title="链路故障恢复功能"></a>链路故障恢复功能</h4><ul>
<li><p>实现代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_flow</span>(<span class="params">self, datapath,out_port</span>):</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        mod = parser.OFPFlowMod(datapath=datapath, command=ofproto.OFPFC_DELETE, out_port=out_port, out_group=ofproto.OFPG_ANY)</span><br><span class="line">        datapath.send_msg(mod)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPPortStatus, [CONFIG_DISPATCHER, MAIN_DISPATCHER, DEAD_DISPATCHER, HANDSHAKE_DISPATCHER]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_OFPPortStatus_msg</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        <span class="comment"># ofproto.OFPPR_ADD 0 , ofproto.OFPPR_DELETE 1 , ofproto.OFPPR_MODIFY 2</span></span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        <span class="keyword">if</span> (msg.reason == <span class="number">2</span> <span class="keyword">and</span> msg.desc.config == <span class="number">0</span>):</span><br><span class="line">            i = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(self.path):</span><br><span class="line">                self.delete_flow(datapath=self.datapaths[self.path[i][<span class="number">0</span>]],out_port=self.path[i][<span class="number">1</span>])</span><br><span class="line">                self.delete_flow(datapath=self.datapaths[self.path[i+<span class="number">1</span>][<span class="number">0</span>]],out_port=self.path[i+<span class="number">1</span>][<span class="number">1</span>])</span><br><span class="line">                i += <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p><code>delete_flow</code>函数用于将<code>datapath</code>对应的交换机上流表中通过<code>out_port</code>端口转发的流表项全部删除。每次有连接<code>up</code>或者<code>down</code>时都会触发<code>get_OFPPortStatus_msg</code>函数,调用<code>delete_flow</code>函数将当前路径上的所有相关流表全部删除,然后即可通过<code>install_path</code>函数重新获取最短路径并安装,此时便会切换到另一条可用路径,实现了错误处理。</p>
<p>函数中删除流表的判断条件为<code>msg.reason == 2 and msg.desc.config == 0</code>。<code>msg.reason == 2</code>表示交换机端口状态发生改变，即为<code>OFPPR_MODIFY</code>;<code>msg.desc</code>是当端口状态发生改变时交换机发送给控制器的报文中包含的对端口状态的描述结构,其内容如下。</p>
<p><img src="D:\Vnote\图片\image-20210523152948767.png"></p>
<p>其中<code>config</code>变量用于描述端口的状态，如下图所示。</p>
<p><img src="D:\Vnote\图片\image-20210523153008794.png" alt="image-20210523153008794"></p>
</li>
<li><p>运行结果</p>
<p><img src="D:\Vnote\图片\image-20210523175635209.png" alt="image-20210523175635209"></p>
<p><img src="D:\Vnote\图片\image-20210523175647657.png" alt="image-20210523175647657"></p>
<p><img src="D:\Vnote\图片\image-20210523175714945.png" alt="image-20210523175714945"></p>
</li>
</ul>
<h4 id="实验中出现的问题"><a href="#实验中出现的问题" class="headerlink" title="实验中出现的问题"></a>实验中出现的问题</h4><ul>
<li><p>流表删除不掉问题</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mod = parser.OFPFlowMod(datapath=datapath,command=3, out_put=out_put)</span><br></pre></td></tr></table></figure>

<p>查阅openFlow-1.3.0文档之后，发现如下内容</p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210517202901515.png" alt="image-20210517202901515"></p>
<p>意为在执行删除操作时，必须包含<code>out_put</code>域和<code>out_group</code>域才能正确的删除。</p>
<p>因此在上述代码加上<code>out_group=ofproto.OFPG_ANY</code>后即可删除</p>
</li>
<li><p>丢包问题</p>
<p>由以上的实验结果截图可见，在进行路径切换时会出现丢包现象。分析可得，是由于每次的packet-in包并没有在交换机进行缓存并且控制器也没有发送packet-out包将packet-in包含的报文传回交换机进行处理，因此造成丢包。解决此问题只需在每次安装路径之后发送packet-out包给交换机，根据当前路径指导交换机进行处理即可。</p>
<p>实现代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> pkt_ipv4 <span class="keyword">and</span> (self.ip_to_port.get(pkt_ipv4.dst)) <span class="keyword">and</span> (self.ip_to_port.get(pkt_ipv4.src)):</span><br><span class="line">    (src_dpid, src_port) = self.ip_to_port[pkt_ipv4.src]  <span class="comment"># src dpid and port  源主机连接的交换机的端口和dpid</span></span><br><span class="line">    (dst_dpid, dst_port) = self.ip_to_port[pkt_ipv4.dst]  <span class="comment"># dst dpid and port  目的主机连接的交换机的端口和dpid</span></span><br><span class="line">    self.install_path(src_dpid=src_dpid, dst_dpid=dst_dpid, src_port=src_port, dst_port=dst_port,ev=ev, src=src, </span><br><span class="line">                                dst=dst, pkt_ipv4=pkt_ipv4, pkt_tcp=pkt_tcp)      <span class="comment"># 更新所有交换机的流表</span></span><br><span class="line">    <span class="keyword">if</span>(msg.buffer_id == ofproto.OFP_NO_BUFFER):</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> i&lt;<span class="built_in">len</span>(self.path):</span><br><span class="line">            <span class="keyword">if</span>(self.path[i][<span class="number">0</span>] == dpid):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            i += <span class="number">2</span></span><br><span class="line">        actions = [parser.OFPActionOutput(self.path[i+<span class="number">1</span>][<span class="number">1</span>])]</span><br><span class="line">        out = parser.OFPPacketOut(datapath,buffer_id=ofproto.OFP_NO_BUFFER,in_port=in_port,actions=actions,data=msg.data)</span><br><span class="line">        datapath.send_msg(out)</span><br></pre></td></tr></table></figure>

<p>加入此段代码之后,再次进行上述实验,发现不再丢包。</p>
<p><img src="......%5C%E5%9B%BE%E7%89%87%5Cimage-20210523180656571.png" alt="image-20210523180656571"></p>
</li>
</ul>
<h4 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h4><ul>
<li><p>实验一</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ryu.base <span class="keyword">import</span> app_manager</span><br><span class="line"><span class="keyword">from</span> ryu.controller <span class="keyword">import</span> ofp_event</span><br><span class="line"><span class="keyword">from</span> ryu.topology <span class="keyword">import</span> event</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> CONFIG_DISPATCHER, MAIN_DISPATCHER, DEAD_DISPATCHER, HANDSHAKE_DISPATCHER</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> set_ev_cls</span><br><span class="line"><span class="keyword">from</span> ryu.ofproto <span class="keyword">import</span> ofproto_v1_3</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> packet</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ethernet</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> arp</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ipv4</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> tcp</span><br><span class="line"><span class="keyword">from</span> ryu.topology.api <span class="keyword">import</span> get_link</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ether_types</span><br><span class="line"><span class="keyword">from</span> ryu.app.wsgi <span class="keyword">import</span>  WSGIApplication</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">import</span> network_monitor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dynamic_rules</span>(<span class="params">app_manager.RyuApp</span>):</span></span><br><span class="line">    OFP_VERSIONS = [ofproto_v1_3.OFP_VERSION]</span><br><span class="line">    _CONTEXTS = &#123;</span><br><span class="line">        <span class="string">&quot;Network_Monitor&quot;</span>: network_monitor.Network_Monitor,</span><br><span class="line">        <span class="string">&quot;wsgi&quot;</span>: WSGIApplication</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(dynamic_rules, self).__init__(*args, **kwargs)</span><br><span class="line">        self.mac_to_port = &#123;&#125;                                               <span class="comment"># MAC地址和端口的映射</span></span><br><span class="line">        self.ip_to_mac = &#123;&#125;                                                 <span class="comment"># IP地址和MAC地址的映射</span></span><br><span class="line">        self.mac_to_dpid = &#123;&#125;  <span class="comment"># &#123;mac:(dpid,port)&#125;                          # MAC地址和dpid的映射</span></span><br><span class="line"></span><br><span class="line">        self.datapaths = defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>)</span><br><span class="line">        self.topology_api_app = self</span><br><span class="line">        self.src_links = defaultdict(<span class="keyword">lambda</span>: defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>))     <span class="comment"># 源dpid、端口号，目的dpid、端口号</span></span><br><span class="line"></span><br><span class="line">        self.check_ip_dpid = defaultdict(<span class="built_in">list</span>)</span><br><span class="line"></span><br><span class="line">        self.qos_ip_bw_list = []</span><br><span class="line"></span><br><span class="line">        self.network_monitor = kwargs[<span class="string">&quot;Network_Monitor&quot;</span>]</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        self.ip_to_switch = &#123;&#125;</span><br><span class="line">        self.port_name_to_num = &#123;&#125;                                          <span class="comment"># 交换机的端口名和端口号的对应关系</span></span><br><span class="line"></span><br><span class="line">        self.ip_to_port = &#123;&#125;  <span class="comment">#&#123;ip:(dpid,port)&#125;</span></span><br><span class="line">        <span class="comment">#promise me, use it well :)</span></span><br><span class="line">        self.pathmod = <span class="number">0</span></span><br><span class="line">        self.path = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        self.src = <span class="number">0</span></span><br><span class="line">        self.flag = <span class="number">0</span></span><br><span class="line">        self.i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;进行版本协商和属性请求之后，控制器收到Features Reply&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPSwitchFeatures, CONFIG_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">switch_features_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        datapath = ev.msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        match = parser.OFPMatch()</span><br><span class="line">        actions = [parser.OFPActionOutput(ofproto.OFPP_CONTROLLER,</span><br><span class="line">                                          ofproto.OFPCML_NO_BUFFER)]</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;发送flow mod报文增加流表&#x27;&#x27;&#x27;</span></span><br><span class="line">        self.add_flow(datapath, <span class="number">0</span>, match, actions)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_flow</span>(<span class="params">self, datapath, priority, match, actions, buffer_id=<span class="literal">None</span>, idle_timeout=<span class="number">0</span>, hard_timeout=<span class="number">0</span></span>):</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line"></span><br><span class="line">        inst = [parser.OFPInstructionActions(ofproto.OFPIT_APPLY_ACTIONS,</span><br><span class="line">                                             actions)]</span><br><span class="line">        <span class="keyword">if</span> buffer_id:</span><br><span class="line">            mod = parser.OFPFlowMod(datapath=datapath, buffer_id=buffer_id,</span><br><span class="line">                                    priority=priority, match=match,</span><br><span class="line">                                    idle_timeout=idle_timeout,</span><br><span class="line">                                    hard_timeout=hard_timeout,</span><br><span class="line">                                    instructions=inst)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mod = parser.OFPFlowMod(datapath=datapath, priority=priority,</span><br><span class="line">                                    idle_timeout=idle_timeout,</span><br><span class="line">                                    hard_timeout=hard_timeout,</span><br><span class="line">                                    match=match, instructions=inst)</span><br><span class="line">        datapath.send_msg(mod)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;进行版本协商和数属性请求之后，控制器收到packet in报文&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPPacketIn, MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_packet_in_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        <span class="keyword">if</span> ev.msg.msg_len &lt; ev.msg.total_len:</span><br><span class="line">            self.logger.debug(<span class="string">&quot;packet truncated: only %s of %s bytes&quot;</span>,ev.msg.msg_len, ev.msg.total_len)</span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        in_port = msg.match[<span class="string">&#x27;in_port&#x27;</span>]                          <span class="comment"># 交换机收到此报文的端口</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 解析待处理报文协议</span></span><br><span class="line">        pkt = packet.Packet(msg.data)</span><br><span class="line">        eth = pkt.get_protocols(ethernet.ethernet)[<span class="number">0</span>]           <span class="comment"># 获取以太网协议头部</span></span><br><span class="line">        pkt_arp = pkt.get_protocol(arp.arp)                     <span class="comment"># 获取arp协议头部</span></span><br><span class="line">        pkt_ipv4 = pkt.get_protocol(ipv4.ipv4)                  <span class="comment"># 获取IP协议头部</span></span><br><span class="line">        pkt_tcp = pkt.get_protocol(tcp.tcp)                     <span class="comment"># 获取TCP协议头部</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> eth.ethertype == ether_types.ETH_TYPE_LLDP:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        dst = eth.dst                                           <span class="comment"># 源MAC地址</span></span><br><span class="line">        src = eth.src                                           <span class="comment"># 目的MAC地址</span></span><br><span class="line">        dpid = datapath.<span class="built_in">id</span>                                      <span class="comment"># 交换机信息</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># self.logger.info(&quot;packet in %s %s %s %s&quot;, dpid, src, dst, in_port)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># in rest_topology, self.mac_to_port is for the find for host</span></span><br><span class="line">        self.mac_to_port.setdefault(dpid, &#123;&#125;)                   </span><br><span class="line">        self.mac_to_port[dpid][src] = in_port                   <span class="comment"># 将报文的MAC地址和交换机端口进行映射</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理ARP包</span></span><br><span class="line">        <span class="comment"># arp handle</span></span><br><span class="line">        <span class="keyword">if</span> pkt_arp <span class="keyword">and</span> pkt_arp.opcode == arp.ARP_REQUEST:       <span class="comment"># 如果为arp请求包</span></span><br><span class="line">            <span class="keyword">if</span> pkt_arp.src_ip <span class="keyword">not</span> <span class="keyword">in</span> self.ip_to_mac:            <span class="comment"># 如果源IP地址没有映射到MAC地址</span></span><br><span class="line">                self.ip_to_mac[pkt_arp.src_ip] = src            <span class="comment"># 记录发出ARP请求的主机的IP和MAC地址</span></span><br><span class="line">                self.mac_to_dpid[src] = (dpid, in_port)         <span class="comment"># 记录 MAC地址 与主机直接相连的交换机的端口和dpid</span></span><br><span class="line">                self.ip_to_port[pkt_arp.src_ip] = (dpid, in_port)   <span class="comment"># 记录主机 IP地址 以及 与主机直接相连的叫交换机的端口和dpid</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> pkt_arp.dst_ip <span class="keyword">in</span> self.ip_to_mac:                <span class="comment"># 如果目的IP地址已经映射到了MAC地址，则直接回复给主机</span></span><br><span class="line">                <span class="comment">#self.logger.info(&quot;[PACKET] ARP packet_in.&quot;)</span></span><br><span class="line">                self.handle_arpre(datapath=datapath, port=in_port,</span><br><span class="line">                                  src_mac=self.ip_to_mac[pkt_arp.dst_ip],</span><br><span class="line">                                  dst_mac=src, src_ip=pkt_arp.dst_ip, dst_ip=pkt_arp.src_ip)</span><br><span class="line">            <span class="keyword">else</span>:                                               <span class="comment"># 如果目的IP地址没有映射到MAC地址，</span></span><br><span class="line">                <span class="comment"># to avoid flood when the dst ip not in the network</span></span><br><span class="line">                <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> self.check_ip_dpid[pkt_arp.dst_ip]:       <span class="comment"># 检查连接主机的交换机是否被记录过，记录过，则无需继续寻找，否则再ARP包洪泛</span></span><br><span class="line">                    self.check_ip_dpid[pkt_arp.dst_ip].append(datapath.<span class="built_in">id</span>)</span><br><span class="line">                    out_port = ofproto.OFPP_FLOOD</span><br><span class="line">                    actions = [parser.OFPActionOutput(out_port)]</span><br><span class="line">                    data = <span class="literal">None</span></span><br><span class="line">                    <span class="keyword">if</span> msg.buffer_id == ofproto.OFP_NO_BUFFER:</span><br><span class="line">                        data = msg.data</span><br><span class="line">                    out = parser.OFPPacketOut(datapath=datapath, buffer_id=msg.buffer_id,</span><br><span class="line">                                              in_port=in_port, actions=actions, data=data)</span><br><span class="line">                    datapath.send_msg(out)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> pkt_arp <span class="keyword">and</span> pkt_arp.opcode == arp.ARP_REPLY:       <span class="comment"># 如果为ARP应答包</span></span><br><span class="line">            <span class="keyword">if</span> pkt_arp.src_ip <span class="keyword">not</span> <span class="keyword">in</span> self.ip_to_mac:            <span class="comment"># 如果源IP未被映射为MAC地址</span></span><br><span class="line">                self.ip_to_mac[pkt_arp.src_ip] = src</span><br><span class="line">                self.mac_to_dpid[src] = (dpid, in_port)</span><br><span class="line">                self.ip_to_port[pkt_arp.src_ip] = (dpid, in_port)</span><br><span class="line">            dst_mac = self.ip_to_mac[pkt_arp.dst_ip]</span><br><span class="line">            (dst_dpid, dst_port) = self.mac_to_dpid[dst_mac]</span><br><span class="line">            self.handle_arpre(datapath=self.datapaths[dst_dpid], port=dst_port, src_mac=src, dst_mac=dst_mac,</span><br><span class="line">                              src_ip=pkt_arp.src_ip, dst_ip=pkt_arp.dst_ip)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理IP包</span></span><br><span class="line">        <span class="keyword">if</span> pkt_ipv4 <span class="keyword">and</span> (self.ip_to_port.get(pkt_ipv4.dst)) <span class="keyword">and</span> (self.ip_to_port.get(pkt_ipv4.src)):</span><br><span class="line">            (src_dpid, src_port) = self.ip_to_port[pkt_ipv4.src]  <span class="comment"># src dpid and port  源主机连接的交换机的端口和dpid</span></span><br><span class="line">            (dst_dpid, dst_port) = self.ip_to_port[pkt_ipv4.dst]  <span class="comment"># dst dpid and port  目的主机连接的交换机的端口和dpid</span></span><br><span class="line">            self.install_path(src_dpid=src_dpid, dst_dpid=dst_dpid, src_port=src_port, dst_port=dst_port,ev=ev, src=src, </span><br><span class="line">            dst=dst, pkt_ipv4=pkt_ipv4, pkt_tcp=pkt_tcp)      <span class="comment"># 更新所有交换机的流表</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(msg.buffer_id == ofproto.OFP_NO_BUFFER):</span><br><span class="line">                i = <span class="number">0</span></span><br><span class="line">                <span class="keyword">while</span> i&lt;<span class="built_in">len</span>(self.path):</span><br><span class="line">                    <span class="keyword">if</span>(self.path[i][<span class="number">0</span>] == dpid):</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    i += <span class="number">2</span></span><br><span class="line">                actions = [parser.OFPActionOutput(self.path[i+<span class="number">1</span>][<span class="number">1</span>])]</span><br><span class="line">                out = parser.OFPPacketOut(datapath,buffer_id=ofproto.OFP_NO_BUFFER,in_port=in_port,actions=actions,data=msg.data)</span><br><span class="line">                datapath.send_msg(out)</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 发送构造的报文</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_pkt</span>(<span class="params">self, datapath, port, pkt</span>):</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        pkt.serialize()</span><br><span class="line">        data = pkt.data</span><br><span class="line">        actions = [parser.OFPActionOutput(port=port)]</span><br><span class="line">        out = parser.OFPPacketOut(datapath=datapath, buffer_id=ofproto.OFP_NO_BUFFER, in_port=ofproto.OFPP_CONTROLLER,</span><br><span class="line">                                  actions=actions, data=data)</span><br><span class="line">        datapath.send_msg(out)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 发送ARP应答包</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_arpre</span>(<span class="params">self, datapath, port, src_mac, dst_mac, src_ip, dst_ip</span>):</span></span><br><span class="line">        pkt = packet.Packet()</span><br><span class="line">        pkt.add_protocol(ethernet.ethernet(ethertype=<span class="number">0x0806</span>, dst=dst_mac, src=src_mac))</span><br><span class="line">        pkt.add_protocol(arp.arp(opcode=arp.ARP_REPLY, src_mac=src_mac, src_ip=src_ip, dst_mac=dst_mac, dst_ip=dst_ip))</span><br><span class="line">        self.send_pkt(datapath, port, pkt)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_path</span>(<span class="params">self, src_dpid, dst_dpid, src_port, dst_port, ev, src, dst, pkt_ipv4, pkt_tcp</span>):</span></span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">       </span><br><span class="line">        mid_path = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 获取路径</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.src != src_dpid:</span><br><span class="line">            self.i += <span class="number">1</span></span><br><span class="line">            self.src = src_dpid</span><br><span class="line">        <span class="keyword">if</span> self.i == <span class="number">3</span>:</span><br><span class="line">            self.flag  = <span class="number">1</span> - self.flag   </span><br><span class="line">            self.i = <span class="number">1</span>    </span><br><span class="line">        <span class="keyword">if</span>(self.flag == <span class="number">0</span>):      <span class="comment"># 最短路径</span></span><br><span class="line">            mid_path = self.short_path(src=src_dpid, dst=dst_dpid, w=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mid_path = self.long_path(src=src_dpid,dst=dst_dpid)</span><br><span class="line">         </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mid_path <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.path = <span class="literal">None</span></span><br><span class="line">        self.path = [(src_dpid, src_port)] + mid_path + [(dst_dpid, dst_port)]                              </span><br><span class="line">        </span><br><span class="line">        self.logger.info(<span class="string">&quot;path : %s&quot;</span>, <span class="built_in">str</span>(self.path))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.path) - <span class="number">2</span>, -<span class="number">1</span>, -<span class="number">2</span>):</span><br><span class="line">            datapath_path = self.datapaths[self.path[i][<span class="number">0</span>]]                                                 <span class="comment"># 获取相应的交换机datapath</span></span><br><span class="line"></span><br><span class="line">            match = parser.OFPMatch(in_port=self.path[i][<span class="number">1</span>], eth_src=src, eth_dst=dst, eth_type=<span class="number">0x0800</span>,</span><br><span class="line">                                    ipv4_src=pkt_ipv4.src, ipv4_dst=pkt_ipv4.dst)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> i &lt; (<span class="built_in">len</span>(self.path) - <span class="number">2</span>):</span><br><span class="line">                actions = [parser.OFPActionOutput(self.path[i + <span class="number">1</span>][<span class="number">1</span>])]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                actions = [parser.OFPActionSetField(eth_dst=self.ip_to_mac.get(pkt_ipv4.dst)),parser.OFPActionOutput(self.path[i + <span class="number">1</span>][<span class="number">1</span>])]</span><br><span class="line">            self.add_flow(datapath_path, <span class="number">100</span>, match, actions, idle_timeout=<span class="number">0</span>, hard_timeout=<span class="number">5</span>)           <span class="comment"># 更新流表</span></span><br><span class="line">        <span class="comment"># time_install = datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S.%f&#x27;)</span></span><br><span class="line">        <span class="comment"># self.logger.info(&quot;time_install: %s&quot;, time_install)</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;遍历拓扑图筛选最短路径    Dijkstra算法&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">short_path</span>(<span class="params">self, src, dst, w=<span class="number">1</span></span>):</span>                                     </span><br><span class="line">        <span class="keyword">if</span> src == dst:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        result = defaultdict(<span class="keyword">lambda</span>: defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>))             <span class="comment"># 记录前一个节点，用于推出最短路径</span></span><br><span class="line">        distance = defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>)           <span class="comment"># 存放距离</span></span><br><span class="line">        <span class="comment"># the node is checked</span></span><br><span class="line">        seen = [src]                    <span class="comment"># 表示已经处理过的节点</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># the distance to src</span></span><br><span class="line">        distance[src] = <span class="number">0</span>               <span class="comment"># 表示当前所有节点到源节点的最短距离</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(seen) &lt; <span class="built_in">len</span>(self.src_links):                              <span class="comment"># 是否扫描所有的节点</span></span><br><span class="line">            node = seen[-<span class="number">1</span>]                                                 <span class="comment"># node为上一个被检查的节点</span></span><br><span class="line">            <span class="keyword">if</span> node == dst:                                                 <span class="comment"># 目的节点已经被检查过了，可以得出结论</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">for</span> (temp_src, temp_dst) <span class="keyword">in</span> self.src_links[node]:               <span class="comment"># 遍历上个节点的所有连接，修改距离值</span></span><br><span class="line">                <span class="keyword">if</span> temp_dst <span class="keyword">not</span> <span class="keyword">in</span> seen:                                    <span class="comment"># 另一个节点没有被检查过</span></span><br><span class="line">                    temp_src_port = self.src_links[node][(temp_src, temp_dst)][<span class="number">0</span>]                       <span class="comment"># 获取端口号</span></span><br><span class="line">                    temp_dst_port = self.src_links[node][(temp_src, temp_dst)][<span class="number">1</span>]</span><br><span class="line">                    <span class="keyword">if</span> (distance[temp_dst] <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> (distance[temp_dst] &gt; distance[temp_src] + w):</span><br><span class="line">                        distance[temp_dst] = distance[temp_src] + w</span><br><span class="line">                        <span class="comment"># result = &#123;&quot;dpid&quot;:(link_src, src_port, link_dst, dst_port)&#125;</span></span><br><span class="line">                        result[temp_dst] = (temp_src, temp_src_port, temp_dst, temp_dst_port)</span><br><span class="line">            min_node = <span class="literal">None</span></span><br><span class="line">            min_path = <span class="number">999</span></span><br><span class="line">            <span class="comment"># get the min_path node 找到当前distance值最小的节点，将其加入seen列表</span></span><br><span class="line">            <span class="keyword">for</span> temp_node <span class="keyword">in</span> distance:</span><br><span class="line">                <span class="keyword">if</span> (temp_node <span class="keyword">not</span> <span class="keyword">in</span> seen) <span class="keyword">and</span> (distance[temp_node] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">                    <span class="keyword">if</span> distance[temp_node] &lt; min_path:</span><br><span class="line">                        min_node = temp_node</span><br><span class="line">                        min_path = distance[temp_node]</span><br><span class="line">            <span class="keyword">if</span> min_node <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            seen.append(min_node)</span><br><span class="line"></span><br><span class="line">        path = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> dst <span class="keyword">not</span> <span class="keyword">in</span> result:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (dst <span class="keyword">in</span> result) <span class="keyword">and</span> (result[dst] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):                <span class="comment"># 倒推最短路径</span></span><br><span class="line">            path = [result[dst][<span class="number">2</span>:<span class="number">4</span>]] + path</span><br><span class="line">            path = [result[dst][<span class="number">0</span>:<span class="number">2</span>]] + path</span><br><span class="line">            dst = result[dst][<span class="number">0</span>]</span><br><span class="line">        <span class="comment">#self.logger.info(&quot;path : %s&quot;, str(path))</span></span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line">    <span class="comment"># this function might be useful, but who knows anyway</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">long_path</span>(<span class="params">self, src, dst</span>):</span></span><br><span class="line">        path1 = [(<span class="number">1</span>,<span class="number">2</span>),(<span class="number">2</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">1</span>),(<span class="number">3</span>,<span class="number">2</span>),(<span class="number">5</span>,<span class="number">2</span>)]</span><br><span class="line">        path2 = [(<span class="number">5</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">2</span>),(<span class="number">2</span>,<span class="number">1</span>),(<span class="number">1</span>,<span class="number">2</span>)]</span><br><span class="line">        <span class="keyword">if</span> src == path1[<span class="number">0</span>][<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">return</span> path1</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> path2</span><br><span class="line">  </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 交换机状态改变时触发此函数</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPStateChange, [MAIN_DISPATCHER, DEAD_DISPATCHER]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">state_change_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        datapath = ev.datapath</span><br><span class="line">        <span class="comment"># 建立连接则记录datapath</span></span><br><span class="line">        <span class="keyword">if</span> ev.state == MAIN_DISPATCHER:</span><br><span class="line">            <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> self.datapaths:</span><br><span class="line">                self.datapaths[datapath.<span class="built_in">id</span>] = datapath</span><br><span class="line">        <span class="comment"># 断开连接则删除datapath</span></span><br><span class="line">        <span class="keyword">elif</span> ev.state == DEAD_DISPATCHER:</span><br><span class="line">            <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">in</span> self.datapaths:</span><br><span class="line">                <span class="keyword">del</span> self.datapaths[datapath.<span class="built_in">id</span>]</span><br><span class="line">        <span class="comment">#self.logger.info(&quot;datapaths : %s&quot;, self.datapaths)</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;获取网络的拓扑结构&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># 当增加、移除交换机、交换机增加端口、移除端口、修改端口、增加连接、移除连接时触发事件</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">[event.EventSwitchEnter, event.EventSwitchLeave, event.EventPortAdd, event.EventPortDelete,</span></span></span><br><span class="line"><span class="params"><span class="meta">        event.EventPortModify, event.EventLinkAdd, event.EventLinkDelete]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_topology</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        links_list = get_link(self.topology_api_app,<span class="literal">None</span>)                      <span class="comment"># 获取拓扑图中的连接</span></span><br><span class="line">        self.src_links.clear()</span><br><span class="line">        <span class="keyword">for</span> link <span class="keyword">in</span> links_list:</span><br><span class="line">            sw_src = link.src.dpid</span><br><span class="line">            sw_dst = link.dst.dpid</span><br><span class="line">            src_port = link.src.port_no</span><br><span class="line">            dst_port = link.dst.port_no</span><br><span class="line">            src_port_name = link.src.name</span><br><span class="line">            dst_port_name = link.dst.name</span><br><span class="line">            self.port_name_to_num[src_port_name] = src_port                     <span class="comment"># 连接源端口名对应的源端口号</span></span><br><span class="line">            self.port_name_to_num[dst_port_name] = dst_port                     <span class="comment"># 连接目的端口名对应的目的端口号</span></span><br><span class="line">            self.src_links[sw_src][(sw_src, sw_dst)] = (src_port, dst_port)     </span><br><span class="line">            self.src_links[sw_dst][(sw_dst, sw_src)] = (dst_port, src_port)</span><br><span class="line">            <span class="comment"># self.logger.info(&quot;****src_port_name : %s&quot;, str(src_port_name))</span></span><br><span class="line">            <span class="comment"># self.logger.info(&quot;src_links : %s&quot;, str(self.src_links))</span></span><br><span class="line">            <span class="comment"># self.logger.info(&quot;port_name_to_num : %s&quot;, str(self.port_name_to_num))</span></span><br></pre></td></tr></table></figure></li>
<li><p>实验二</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ryu.base <span class="keyword">import</span> app_manager</span><br><span class="line"><span class="keyword">from</span> ryu.controller <span class="keyword">import</span> ofp_event</span><br><span class="line"><span class="keyword">from</span> ryu.topology <span class="keyword">import</span> event</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> CONFIG_DISPATCHER, MAIN_DISPATCHER, DEAD_DISPATCHER, HANDSHAKE_DISPATCHER</span><br><span class="line"><span class="keyword">from</span> ryu.controller.handler <span class="keyword">import</span> set_ev_cls</span><br><span class="line"><span class="keyword">from</span> ryu.ofproto <span class="keyword">import</span> ofproto_v1_3</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> packet</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ethernet</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> arp</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ipv4</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> tcp</span><br><span class="line"><span class="keyword">from</span> ryu.topology.api <span class="keyword">import</span> get_link</span><br><span class="line"><span class="keyword">from</span> ryu.lib.packet <span class="keyword">import</span> ether_types</span><br><span class="line"><span class="keyword">from</span> ryu.app.wsgi <span class="keyword">import</span>  WSGIApplication</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">import</span> network_monitor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dynamic_rules</span>(<span class="params">app_manager.RyuApp</span>):</span></span><br><span class="line">    OFP_VERSIONS = [ofproto_v1_3.OFP_VERSION]</span><br><span class="line">    _CONTEXTS = &#123;</span><br><span class="line">        <span class="string">&quot;Network_Monitor&quot;</span>: network_monitor.Network_Monitor,</span><br><span class="line">        <span class="string">&quot;wsgi&quot;</span>: WSGIApplication</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(dynamic_rules, self).__init__(*args, **kwargs)</span><br><span class="line">        self.mac_to_port = &#123;&#125;                                               <span class="comment"># MAC地址和端口的映射</span></span><br><span class="line">        self.ip_to_mac = &#123;&#125;                                                 <span class="comment"># IP地址和MAC地址的映射</span></span><br><span class="line">        self.mac_to_dpid = &#123;&#125;  <span class="comment"># &#123;mac:(dpid,port)&#125;                          # MAC地址和dpid的映射</span></span><br><span class="line"></span><br><span class="line">        self.datapaths = defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>)</span><br><span class="line">        self.topology_api_app = self</span><br><span class="line">        self.src_links = defaultdict(<span class="keyword">lambda</span>: defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>))     <span class="comment"># 源dpid、端口号，目的dpid、端口号</span></span><br><span class="line"></span><br><span class="line">        self.check_ip_dpid = defaultdict(<span class="built_in">list</span>)</span><br><span class="line"></span><br><span class="line">        self.qos_ip_bw_list = []</span><br><span class="line"></span><br><span class="line">        self.network_monitor = kwargs[<span class="string">&quot;Network_Monitor&quot;</span>]</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        self.ip_to_switch = &#123;&#125;</span><br><span class="line">        self.port_name_to_num = &#123;&#125;                                          <span class="comment"># 交换机的端口名和端口号的对应关系</span></span><br><span class="line"></span><br><span class="line">        self.ip_to_port = &#123;&#125;  <span class="comment">#&#123;ip:(dpid,port)&#125;</span></span><br><span class="line">        <span class="comment">#promise me, use it well :)</span></span><br><span class="line">        self.pathmod = <span class="number">0</span></span><br><span class="line">        self.path = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        self.flag  = <span class="number">0</span>                  <span class="comment"># 用于表示当前的流表是哪一条路径，0为最短，1为最长</span></span><br><span class="line">        self.i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;进行版本协商和属性请求之后，控制器收到Features Reply&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPSwitchFeatures, CONFIG_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">switch_features_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        datapath = ev.msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        match = parser.OFPMatch()</span><br><span class="line">        actions = [parser.OFPActionOutput(ofproto.OFPP_CONTROLLER,</span><br><span class="line">                                          ofproto.OFPCML_NO_BUFFER)]</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;发送flow mod报文增加流表&#x27;&#x27;&#x27;</span></span><br><span class="line">        self.add_flow(datapath, <span class="number">0</span>, match, actions)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_flow</span>(<span class="params">self, datapath, priority, match, actions, buffer_id=<span class="literal">None</span>, idle_timeout=<span class="number">0</span>, hard_timeout=<span class="number">0</span></span>):</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line"></span><br><span class="line">        inst = [parser.OFPInstructionActions(ofproto.OFPIT_APPLY_ACTIONS,</span><br><span class="line">                                             actions)]</span><br><span class="line">        <span class="keyword">if</span> buffer_id:</span><br><span class="line">            mod = parser.OFPFlowMod(datapath=datapath, buffer_id=buffer_id,</span><br><span class="line">                                    priority=priority, match=match,</span><br><span class="line">                                    idle_timeout=idle_timeout,</span><br><span class="line">                                    hard_timeout=hard_timeout,</span><br><span class="line">                                    instructions=inst)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mod = parser.OFPFlowMod(datapath=datapath, priority=priority,</span><br><span class="line">                                    idle_timeout=idle_timeout,</span><br><span class="line">                                    hard_timeout=hard_timeout,</span><br><span class="line">                                    match=match, instructions=inst)</span><br><span class="line">        datapath.send_msg(mod)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;进行版本协商和属性请求之后，控制器收到packet in报文&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPPacketIn, MAIN_DISPATCHER</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_packet_in_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        <span class="keyword">if</span> ev.msg.msg_len &lt; ev.msg.total_len:</span><br><span class="line">            self.logger.debug(<span class="string">&quot;packet truncated: only %s of %s bytes&quot;</span>,ev.msg.msg_len, ev.msg.total_len)</span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        in_port = msg.match[<span class="string">&#x27;in_port&#x27;</span>]                          <span class="comment"># 交换机收到此报文的端口</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 解析待处理报文协议</span></span><br><span class="line">        pkt = packet.Packet(msg.data)</span><br><span class="line">        eth = pkt.get_protocols(ethernet.ethernet)[<span class="number">0</span>]           <span class="comment"># 获取以太网协议头部</span></span><br><span class="line">        pkt_arp = pkt.get_protocol(arp.arp)                     <span class="comment"># 获取arp协议头部</span></span><br><span class="line">        pkt_ipv4 = pkt.get_protocol(ipv4.ipv4)                  <span class="comment"># 获取IP协议头部</span></span><br><span class="line">        pkt_tcp = pkt.get_protocol(tcp.tcp)                     <span class="comment"># 获取TCP协议头部</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> eth.ethertype == ether_types.ETH_TYPE_LLDP:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        dst = eth.dst                                           <span class="comment"># 源MAC地址</span></span><br><span class="line">        src = eth.src                                           <span class="comment"># 目的MAC地址</span></span><br><span class="line">        dpid = datapath.<span class="built_in">id</span>                                      <span class="comment"># 交换机信息</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># self.logger.info(&quot;packet in %s %s %s %s&quot;, dpid, src, dst, in_port)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># in rest_topology, self.mac_to_port is for the find for host</span></span><br><span class="line">        self.mac_to_port.setdefault(dpid, &#123;&#125;)                   </span><br><span class="line">        self.mac_to_port[dpid][src] = in_port                   <span class="comment"># 将报文的MAC地址和交换机端口进行映射</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理ARP包</span></span><br><span class="line">        <span class="comment"># arp handle</span></span><br><span class="line">        <span class="keyword">if</span> pkt_arp <span class="keyword">and</span> pkt_arp.opcode == arp.ARP_REQUEST:       <span class="comment"># 如果为arp请求包</span></span><br><span class="line">            <span class="keyword">if</span> pkt_arp.src_ip <span class="keyword">not</span> <span class="keyword">in</span> self.ip_to_mac:            <span class="comment"># 如果源IP地址没有映射到MAC地址</span></span><br><span class="line">                self.ip_to_mac[pkt_arp.src_ip] = src            <span class="comment"># 记录发出ARP请求的主机的IP和MAC地址</span></span><br><span class="line">                self.mac_to_dpid[src] = (dpid, in_port)         <span class="comment"># 记录 MAC地址 与主机直接相连的交换机的端口和dpid</span></span><br><span class="line">                self.ip_to_port[pkt_arp.src_ip] = (dpid, in_port)   <span class="comment"># 记录主机 IP地址 以及 与主机直接相连的交换机的端口和dpid</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> pkt_arp.dst_ip <span class="keyword">in</span> self.ip_to_mac:                <span class="comment"># 如果目的IP地址已经映射到了MAC地址，则直接回复给主机</span></span><br><span class="line">                <span class="comment">#self.logger.info(&quot;[PACKET] ARP packet_in.&quot;)</span></span><br><span class="line">                self.handle_arpre(datapath=datapath, port=in_port,</span><br><span class="line">                                  src_mac=self.ip_to_mac[pkt_arp.dst_ip],</span><br><span class="line">                                  dst_mac=src, src_ip=pkt_arp.dst_ip, dst_ip=pkt_arp.src_ip)</span><br><span class="line">            <span class="keyword">else</span>:                                               <span class="comment"># 如果目的IP地址没有映射到MAC地址，</span></span><br><span class="line">                <span class="comment"># to avoid flood when the dst ip not in the network</span></span><br><span class="line">                <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> self.check_ip_dpid[pkt_arp.dst_ip]:       <span class="comment"># 检查连接主机的交换机是否被记录过，记录过，则无需继续寻找，否则再ARP包洪泛</span></span><br><span class="line">                    self.check_ip_dpid[pkt_arp.dst_ip].append(datapath.<span class="built_in">id</span>)</span><br><span class="line">                    out_port = ofproto.OFPP_FLOOD</span><br><span class="line">                    actions = [parser.OFPActionOutput(out_port)]</span><br><span class="line">                    data = <span class="literal">None</span></span><br><span class="line">                    <span class="keyword">if</span> msg.buffer_id == ofproto.OFP_NO_BUFFER:</span><br><span class="line">                        data = msg.data</span><br><span class="line">                    out = parser.OFPPacketOut(datapath=datapath, buffer_id=msg.buffer_id,</span><br><span class="line">                                              in_port=in_port, actions=actions, data=data)</span><br><span class="line">                    datapath.send_msg(out)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> pkt_arp <span class="keyword">and</span> pkt_arp.opcode == arp.ARP_REPLY:       <span class="comment"># 如果为ARP应答包</span></span><br><span class="line">            <span class="keyword">if</span> pkt_arp.src_ip <span class="keyword">not</span> <span class="keyword">in</span> self.ip_to_mac:            <span class="comment"># 如果源IP未被映射为MAC地址</span></span><br><span class="line">                self.ip_to_mac[pkt_arp.src_ip] = src</span><br><span class="line">                self.mac_to_dpid[src] = (dpid, in_port)</span><br><span class="line">                self.ip_to_port[pkt_arp.src_ip] = (dpid, in_port)</span><br><span class="line">            dst_mac = self.ip_to_mac[pkt_arp.dst_ip]</span><br><span class="line">            (dst_dpid, dst_port) = self.mac_to_dpid[dst_mac]</span><br><span class="line">            self.handle_arpre(datapath=self.datapaths[dst_dpid], port=dst_port, src_mac=src, dst_mac=dst_mac,</span><br><span class="line">                              src_ip=pkt_arp.src_ip, dst_ip=pkt_arp.dst_ip)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理IP包</span></span><br><span class="line">        <span class="keyword">if</span> pkt_ipv4 <span class="keyword">and</span> (self.ip_to_port.get(pkt_ipv4.dst)) <span class="keyword">and</span> (self.ip_to_port.get(pkt_ipv4.src)):</span><br><span class="line">            (src_dpid, src_port) = self.ip_to_port[pkt_ipv4.src]  <span class="comment"># src dpid and port  源主机连接的交换机的端口和dpid</span></span><br><span class="line">            (dst_dpid, dst_port) = self.ip_to_port[pkt_ipv4.dst]  <span class="comment"># dst dpid and port  目的主机连接的交换机的端口和dpid</span></span><br><span class="line">            self.install_path(src_dpid=src_dpid, dst_dpid=dst_dpid, src_port=src_port, dst_port=dst_port,ev=ev, src=src, </span><br><span class="line">                                dst=dst, pkt_ipv4=pkt_ipv4, pkt_tcp=pkt_tcp)      <span class="comment"># 更新所有交换机的流表</span></span><br><span class="line">            <span class="keyword">if</span>(msg.buffer_id == ofproto.OFP_NO_BUFFER):</span><br><span class="line">                i = <span class="number">0</span></span><br><span class="line">                <span class="keyword">while</span> i&lt;<span class="built_in">len</span>(self.path):</span><br><span class="line">                    <span class="keyword">if</span>(self.path[i][<span class="number">0</span>] == dpid):</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    i += <span class="number">2</span></span><br><span class="line">                actions = [parser.OFPActionOutput(self.path[i+<span class="number">1</span>][<span class="number">1</span>])]</span><br><span class="line">                out = parser.OFPPacketOut(datapath,buffer_id=ofproto.OFP_NO_BUFFER,in_port=in_port,actions=actions,data=msg.data)</span><br><span class="line">                datapath.send_msg(out)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 发送packet-out报文</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_pkt</span>(<span class="params">self, datapath, port, pkt</span>):</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        pkt.serialize()</span><br><span class="line">        data = pkt.data</span><br><span class="line">        actions = [parser.OFPActionOutput(port=port)]</span><br><span class="line">        out = parser.OFPPacketOut(datapath=datapath, buffer_id=ofproto.OFP_NO_BUFFER, in_port=ofproto.OFPP_CONTROLLER,</span><br><span class="line">                                  actions=actions, data=data)</span><br><span class="line">        datapath.send_msg(out)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 发送ARP应答包</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_arpre</span>(<span class="params">self, datapath, port, src_mac, dst_mac, src_ip, dst_ip</span>):</span></span><br><span class="line">        pkt = packet.Packet()</span><br><span class="line">        pkt.add_protocol(ethernet.ethernet(ethertype=<span class="number">0x0806</span>, dst=dst_mac, src=src_mac))</span><br><span class="line">        pkt.add_protocol(arp.arp(opcode=arp.ARP_REPLY, src_mac=src_mac, src_ip=src_ip, dst_mac=dst_mac, dst_ip=dst_ip))</span><br><span class="line">        self.send_pkt(datapath, port, pkt)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_path</span>(<span class="params">self, src_dpid, dst_dpid, src_port, dst_port, ev, src, dst, pkt_ipv4, pkt_tcp</span>):</span></span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">       </span><br><span class="line">        mid_path = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 获取路径</span></span><br><span class="line">        mid_path = self.short_path(src=src_dpid, dst=dst_dpid, w=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mid_path <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.path = <span class="literal">None</span></span><br><span class="line">        self.path = [(src_dpid, src_port)] + mid_path + [(dst_dpid, dst_port)]                              </span><br><span class="line">        </span><br><span class="line">        self.logger.info(<span class="string">&quot;path : %s&quot;</span>, <span class="built_in">str</span>(self.path))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.path) - <span class="number">2</span>, -<span class="number">1</span>, -<span class="number">2</span>):</span><br><span class="line">            datapath_path = self.datapaths[self.path[i][<span class="number">0</span>]]                                                 <span class="comment"># 获取相应的交换机datapath</span></span><br><span class="line"></span><br><span class="line">            match = parser.OFPMatch(in_port=self.path[i][<span class="number">1</span>], eth_src=src, eth_dst=dst, eth_type=<span class="number">0x0800</span>,</span><br><span class="line">                                    ipv4_src=pkt_ipv4.src, ipv4_dst=pkt_ipv4.dst)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> i &lt; (<span class="built_in">len</span>(self.path) - <span class="number">2</span>):</span><br><span class="line">                actions = [parser.OFPActionOutput(self.path[i + <span class="number">1</span>][<span class="number">1</span>])]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                actions = [parser.OFPActionSetField(eth_dst=self.ip_to_mac.get(pkt_ipv4.dst)),</span><br><span class="line">                            parser.OFPActionOutput(self.path[i + <span class="number">1</span>][<span class="number">1</span>])]</span><br><span class="line">            self.add_flow(datapath_path, <span class="number">100</span>, match, actions, idle_timeout=<span class="number">0</span>, hard_timeout=<span class="number">0</span>)           <span class="comment"># 更新流表</span></span><br><span class="line">        <span class="comment"># time_install = datetime.datetime.now().strftime(&#x27;%Y-%m-%d %H:%M:%S.%f&#x27;)</span></span><br><span class="line">        <span class="comment"># self.logger.info(&quot;time_install: %s&quot;, time_install)</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;遍历拓扑图筛选最短路径    Dijkstra算法&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">short_path</span>(<span class="params">self, src, dst, w=<span class="number">1</span></span>):</span>                                    </span><br><span class="line">        <span class="keyword">if</span> src == dst:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        result = defaultdict(<span class="keyword">lambda</span>: defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>))             <span class="comment"># 几记录前一个节点，用于推出最短路径</span></span><br><span class="line">        distance = defaultdict(<span class="keyword">lambda</span>: <span class="literal">None</span>)           <span class="comment"># 存放距离</span></span><br><span class="line">        <span class="comment"># the node is checked</span></span><br><span class="line">        seen = [src]                    <span class="comment"># 表示已经处理过的节点</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># the distance to src</span></span><br><span class="line">        distance[src] = <span class="number">0</span>               <span class="comment"># 表示当前所有节点到源节点的最短距离</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(seen) &lt; <span class="built_in">len</span>(self.src_links):                              <span class="comment"># 是否扫描所有的节点</span></span><br><span class="line">            node = seen[-<span class="number">1</span>]                                                 <span class="comment"># node为上一个被检查的节点</span></span><br><span class="line">            <span class="keyword">if</span> node == dst:                                                 <span class="comment"># 目的节点已经被检查过了，可以得出结论</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">for</span> (temp_src, temp_dst) <span class="keyword">in</span> self.src_links[node]:               <span class="comment"># 遍历上个节点的所有连接，修改距离值</span></span><br><span class="line">                <span class="keyword">if</span> temp_dst <span class="keyword">not</span> <span class="keyword">in</span> seen:                                    <span class="comment"># 另一个节点没有被检查过</span></span><br><span class="line">                    temp_src_port = self.src_links[node][(temp_src, temp_dst)][<span class="number">0</span>]                       <span class="comment"># 获取端口号</span></span><br><span class="line">                    temp_dst_port = self.src_links[node][(temp_src, temp_dst)][<span class="number">1</span>]</span><br><span class="line">                    <span class="keyword">if</span> (distance[temp_dst] <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> (distance[temp_dst] &gt; distance[temp_src] + w):</span><br><span class="line">                        distance[temp_dst] = distance[temp_src] + w</span><br><span class="line">                        <span class="comment"># result = &#123;&quot;dpid&quot;:(link_src, src_port, link_dst, dst_port)&#125;</span></span><br><span class="line">                        result[temp_dst] = (temp_src, temp_src_port, temp_dst, temp_dst_port)</span><br><span class="line">            min_node = <span class="literal">None</span></span><br><span class="line">            min_path = <span class="number">999</span></span><br><span class="line">            <span class="comment"># get the min_path node 找到当前distance值最小的节点，将其加入seen列表</span></span><br><span class="line">            <span class="keyword">for</span> temp_node <span class="keyword">in</span> distance:</span><br><span class="line">                <span class="keyword">if</span> (temp_node <span class="keyword">not</span> <span class="keyword">in</span> seen) <span class="keyword">and</span> (distance[temp_node] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):</span><br><span class="line">                    <span class="keyword">if</span> distance[temp_node] &lt; min_path:</span><br><span class="line">                        min_node = temp_node</span><br><span class="line">                        min_path = distance[temp_node]</span><br><span class="line">            <span class="keyword">if</span> min_node <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            seen.append(min_node)</span><br><span class="line"></span><br><span class="line">        path = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> dst <span class="keyword">not</span> <span class="keyword">in</span> result:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (dst <span class="keyword">in</span> result) <span class="keyword">and</span> (result[dst] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>):                <span class="comment"># 倒推最短路径</span></span><br><span class="line">            path = [result[dst][<span class="number">2</span>:<span class="number">4</span>]] + path</span><br><span class="line">            path = [result[dst][<span class="number">0</span>:<span class="number">2</span>]] + path</span><br><span class="line">            dst = result[dst][<span class="number">0</span>]</span><br><span class="line">        <span class="comment">#self.logger.info(&quot;path : %s&quot;, str(path))</span></span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 交换机状态改变时触发此函数</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPStateChange, [MAIN_DISPATCHER, DEAD_DISPATCHER]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">state_change_handler</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        datapath = ev.datapath</span><br><span class="line">        <span class="comment"># 建立连接则记录datapath</span></span><br><span class="line">        <span class="keyword">if</span> ev.state == MAIN_DISPATCHER:</span><br><span class="line">            <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> self.datapaths:</span><br><span class="line">                self.datapaths[datapath.<span class="built_in">id</span>] = datapath</span><br><span class="line">        <span class="comment"># 断开连接则删除datapath</span></span><br><span class="line">        <span class="keyword">elif</span> ev.state == DEAD_DISPATCHER:</span><br><span class="line">            <span class="keyword">if</span> datapath.<span class="built_in">id</span> <span class="keyword">in</span> self.datapaths:</span><br><span class="line">                <span class="keyword">del</span> self.datapaths[datapath.<span class="built_in">id</span>]</span><br><span class="line">        <span class="comment">#self.logger.info(&quot;datapaths : %s&quot;, self.datapaths)</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;获取网络的拓扑结构&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># 当增加、移除交换机、交换机增加端口、移除端口、修改端口、增加连接、移除连接时触发事件</span></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">[event.EventSwitchEnter, event.EventSwitchLeave, event.EventPortAdd, event.EventPortDelete,</span></span></span><br><span class="line"><span class="params"><span class="meta">        event.EventPortModify, event.EventLinkAdd, event.EventLinkDelete]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_topology</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        links_list = get_link(self.topology_api_app,<span class="literal">None</span>)                      <span class="comment"># 获取拓扑图中的连接</span></span><br><span class="line">        self.src_links.clear()</span><br><span class="line">        <span class="keyword">for</span> link <span class="keyword">in</span> links_list:</span><br><span class="line">            sw_src = link.src.dpid</span><br><span class="line">            sw_dst = link.dst.dpid</span><br><span class="line">            src_port = link.src.port_no</span><br><span class="line">            dst_port = link.dst.port_no</span><br><span class="line">            src_port_name = link.src.name</span><br><span class="line">            dst_port_name = link.dst.name</span><br><span class="line">            self.port_name_to_num[src_port_name] = src_port                     <span class="comment"># 连接源端口名对应的源端口号</span></span><br><span class="line">            self.port_name_to_num[dst_port_name] = dst_port                     <span class="comment"># 连接目的端口名对应的目的端口号</span></span><br><span class="line">            self.src_links[sw_src][(sw_src, sw_dst)] = (src_port, dst_port)     </span><br><span class="line">            self.src_links[sw_dst][(sw_dst, sw_src)] = (dst_port, src_port)</span><br><span class="line">            <span class="comment"># self.logger.info(&quot;****src_port_name : %s&quot;, str(src_port_name))</span></span><br><span class="line">            <span class="comment"># self.logger.info(&quot;src_links : %s&quot;, str(self.src_links))</span></span><br><span class="line">            <span class="comment"># self.logger.info(&quot;port_name_to_num : %s&quot;, str(self.port_name_to_num))</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># these two functions need to be coded in your own way</span></span><br><span class="line">    <span class="comment"># 删除匹配到的流表</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_flow</span>(<span class="params">self, datapath,out_port</span>):</span></span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        mod = parser.OFPFlowMod(datapath=datapath, command=ofproto.OFPFC_DELETE, out_port=out_port, out_group=ofproto.OFPG_ANY)</span><br><span class="line">        datapath.send_msg(mod)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @set_ev_cls(<span class="params">ofp_event.EventOFPPortStatus, [CONFIG_DISPATCHER, MAIN_DISPATCHER, DEAD_DISPATCHER, HANDSHAKE_DISPATCHER]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_OFPPortStatus_msg</span>(<span class="params">self, ev</span>):</span></span><br><span class="line">        <span class="comment"># ofproto.OFPPR_ADD 0 , ofproto.OFPPR_DELETE 1 , ofproto.OFPPR_MODIFY 2</span></span><br><span class="line">        msg = ev.msg</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        ofproto = datapath.ofproto</span><br><span class="line">        parser = datapath.ofproto_parser</span><br><span class="line">        <span class="keyword">if</span> (msg.reason == <span class="number">2</span> <span class="keyword">and</span> msg.desc.config == <span class="number">0</span>):</span><br><span class="line">            i = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(self.path):</span><br><span class="line">                self.delete_flow(datapath=self.datapaths[self.path[i][<span class="number">0</span>]],out_port=self.path[i][<span class="number">1</span>])</span><br><span class="line">                self.delete_flow(datapath=self.datapaths[self.path[i+<span class="number">1</span>][<span class="number">0</span>]],out_port=self.path[i+<span class="number">1</span>][<span class="number">1</span>])</span><br><span class="line">                i += <span class="number">2</span></span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/JS/06.%20getter%E5%92%8Csetter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱辉">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuhui's yard">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/JS/06.%20getter%E5%92%8Csetter/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-17 21:04:46" itemprop="dateCreated datePublished" datetime="2021-07-17T21:04:46+08:00">2021-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-19 10:26:15" itemprop="dateModified" datetime="2021-06-19T10:26:15+08:00">2021-06-19</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-getter和setter"><a href="#1-getter和setter" class="headerlink" title="1. getter和setter"></a>1. getter和setter</h1><ul>
<li><p>访问器属性可视为由<code>getter</code>和<code>setter</code>共同定义的伪属性。</p>
<h2 id="1-1-Get"><a href="#1-1-Get" class="headerlink" title="1.1. Get"></a>1.1. Get</h2></li>
<li><p>用于将对象属性绑定到查询该属性时将被调用的函数，绑定后的对象属性在被查询时会自动调用此函数。</p>
</li>
</ul>
<h3 id="1-1-1-语法"><a href="#1-1-1-语法" class="headerlink" title="1.1.1. 语法"></a>1.1.1. 语法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">get prop()&#123;...&#125;</span><br><span class="line">get [expression]()&#123;...&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>参数<ul>
<li><code>prop</code>:将要绑定到给定函数的属性名称，即为想要定义的伪属性名称。</li>
<li><code>expression</code>:可由计算得到的属性名，可以将此给定函数绑定到此计算得到的属性名。</li>
</ul>
</li>
<li>注意<ul>
<li><code>getter</code>函数不能有任何参数</li>
<li>标识符即<code>prop</code>可以是数字或者字符串</li>
<li>一个对象中由<code>get</code>定义的伪属性的名称不能和其他属性或者伪属性重名。</li>
<li>由<code>get</code>和<code>set</code>定义的伪属性不能显式的赋予一个值。<h3 id="1-1-2-代码示例"><a href="#1-1-2-代码示例" class="headerlink" title="1.1.2. 代码示例"></a>1.1.2. 代码示例</h3></li>
</ul>
</li>
<li>在新对象初始化时定义一个<code>getter</code>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> person = &#123;</span><br><span class="line">	<span class="attr">name</span>:<span class="string">&quot;zhuhui&quot;</span>,</span><br><span class="line">	<span class="attr">year</span>:<span class="number">10</span>,</span><br><span class="line">	<span class="keyword">get</span> <span class="title">nextyear</span>()&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.year+<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(person.nextyear);</span><br><span class="line"><span class="comment">//输出11</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>delete</code>删除<code>getter</code>函数  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> person.nextyear;</span><br></pre></td></tr></table></figure></li>
<li>使用<code>defineProperty</code>随时为已经创建的对象添加<code>getter</code>访问器  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> person = &#123;</span><br><span class="line">	<span class="attr">name</span>:<span class="string">&quot;zhuhui&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(person,<span class="string">&quot;year&quot;</span>,&#123;</span><br><span class="line">	<span class="attr">get</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(person.year);</span><br><span class="line"><span class="comment">//输出10</span></span><br></pre></td></tr></table></figure></li>
<li>使用由计算得到的属性名  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> a = <span class="string">&#x27;name&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">	<span class="attr">year</span>:<span class="number">10</span>,</span><br><span class="line">	get [a]()&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;zhuhui&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(person.name);</span><br><span class="line"><span class="comment">//输出zhuhui</span></span><br></pre></td></tr></table></figure></li>
<li>使用数字标识符  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> person = &#123;</span><br><span class="line">	<span class="attr">year</span>:<span class="number">10</span>,</span><br><span class="line">	get <span class="number">123</span>()&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;zhuhui&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(person[<span class="string">&quot;123&quot;</span>]);</span><br><span class="line"><span class="comment">//输出zhuhui,123也可以不带引号</span></span><br></pre></td></tr></table></figure></li>
<li><code>get</code>和<code>defineProperty</code>的区别  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">使用get定义的属性定义在对象的原型上</span><br><span class="line">使用defineProperty定义的属性定义在对象上</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">  <span class="keyword">get</span> <span class="title">hello</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;world&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = <span class="keyword">new</span> Example();</span><br><span class="line"><span class="built_in">console</span>.log(obj.hello);</span><br><span class="line"><span class="comment">// &quot;world&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.getOwnPropertyDescriptor(obj, <span class="string">&#x27;hello&#x27;</span>));</span><br><span class="line"><span class="comment">// undefined</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(</span><br><span class="line">  <span class="built_in">Object</span>.getOwnPropertyDescriptor(</span><br><span class="line">    <span class="built_in">Object</span>.getPrototypeOf(obj), <span class="string">&#x27;hello&#x27;</span></span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"><span class="comment">// &#123; configurable: true, enumerable: false, get: function get hello() &#123; return &#x27;world&#x27;; &#125;, set: undefined &#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="1-2-Set"><a href="#1-2-Set" class="headerlink" title="1.2. Set"></a>1.2. Set</h2><ul>
<li>基本和Get相同，只是set函数必须有一个参数。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/JS/09.%20DOM%E6%89%A9%E5%B1%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱辉">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuhui's yard">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/JS/09.%20DOM%E6%89%A9%E5%B1%95/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-17 21:04:46" itemprop="dateCreated datePublished" datetime="2021-07-17T21:04:46+08:00">2021-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-19 10:26:15" itemprop="dateModified" datetime="2021-06-19T10:26:15+08:00">2021-06-19</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="DOM扩展"><a href="#DOM扩展" class="headerlink" title="DOM扩展"></a><code>DOM</code>扩展</h3><hr>
<h4 id="选择符API"><a href="#选择符API" class="headerlink" title="选择符API"></a>选择符<code>API</code></h4><ul>
<li><code>Selectors API</code>致力于让浏览器原生支持<code>CSS</code>查询</li>
<li>两个核心方法为<code>querySelector()</code>和<code>querySelectorAll()</code>，可以通过<code>Element</code>元素和<code>Document</code>元素进行调用</li>
<li><strong><code>querySelector()</code>方法</strong><ul>
<li>参数：1个，<code>CSS</code>选择符(选择器)</li>
<li>返回值：与选择符匹配的第一个元素，如果没有找到，返回<code>null</code></li>
<li>实例  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var body = doucment.querySelector(&quot;body&quot;);        //取得body元素</span><br><span class="line">var myDiv = document.querySelector(&quot;#mydiv&quot;);     //取得id值为mydiv的元素</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><strong><code>querySelectorAll()</code></strong><ul>
<li>参数：同<code>querySelector()</code>方法</li>
<li>返回值：返回所以匹配的元素，返回值是一个<code>nodeList</code>实例，如果没有，则返回的<code>nodeList</code>是空的</li>
<li>实例  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var div = document.querySelectorAll(&quot;div&quot;);</span><br><span class="line">var box = document.querySelectorAll(&quot;.box&quot;);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><strong><code>matchesSelector()</code>方法</strong><ul>
<li>参数：1个，<code>CSS</code>选择符</li>
<li>返回值：布尔值，当调用元素与选择符匹配时返回<code>true</code>，否则返回<code>false</code></li>
<li>只用于<code>Element</code>类型</li>
<li>浏览器没有实现此函数，而是实验性的实现了替代函数<ul>
<li><code>IE9+</code>：<code>msMatchesSelector()</code></li>
<li><code>FireFox3.6+</code>：<code>mozMatchesSelector()</code></li>
<li><code>其他</code>：<code>webkitMatchSelector()</code></li>
</ul>
</li>
<li>想使用此方法最好写一个包装函数  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">      function matchesSelector(element, selector)&#123;</span><br><span class="line">		if (element.matchesSelector)&#123;</span><br><span class="line">			return element.matchesSelector(selector);</span><br><span class="line">		&#125; else if (element.msMatchesSelector)&#123;</span><br><span class="line">			return element.msMatchesSelector(selector);</span><br><span class="line">		&#125; else if (element.mozMatchesSelector)&#123;</span><br><span class="line">			return element.mozMatchesSelector(selector);</span><br><span class="line">		&#125; else if (element.webkitMatchesSelector)&#123;</span><br><span class="line">			return element.webkitMatchesSelector(selector);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			throw new Error(&quot;Not supported&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="元素遍历"><a href="#元素遍历" class="headerlink" title="元素遍历"></a>元素遍历</h4></li>
</ul>
</li>
<li>因为不同的浏览器识别文本结点时，对空格的处理不一致，为了弥补差异，同时保证规范不变，<code>Element Traversal</code>定义新的一组属性</li>
<li><code>Element Traversal API</code>为<code>DOM</code>元素添加了5个属性<ul>
<li><code>childElementCount</code>：返回子元素(不包含文本结点和注释)的个数</li>
<li><code>firstElementChild</code>：指向第一个子元素</li>
<li><code>lastElementChild</code>：指向最后一个子元素</li>
<li><code>previousElementSibling</code>：指向前一个兄弟元素</li>
<li><code>nextElementSibling</code>：指向后一个兄弟元素</li>
</ul>
</li>
<li>使用这些属性不用考虑空白文本结点<h4 id="HTML5"><a href="#HTML5" class="headerlink" title="HTML5"></a><code>HTML5</code></h4></li>
</ul>
<p><strong>与类相关的扩充</strong></p>
<ul>
<li><code>getElementByClassName()</code>方法<ul>
<li>可以通过<code>document</code>对象以及所有的<code>HTML</code>元素调用该方法</li>
<li>参数：1个，一个包含一个或者多个类名的字符串(类名的先后顺序没有影响，之间使用空格隔开)</li>
<li>返回值：带有指定类的所有元素的<code>NodeList</code></li>
<li>调用此方法时，只有位于调用元素子树中的元素才会返回</li>
<li>举例  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var a = document.getElementByClassName(&quot;username current&quot;);</span><br><span class="line">//返回所有类中包含username和current的元素</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>classList</code>属性<ul>
<li>是新的集合类型<code>DOMTokenList</code>的实例，所有元素都有此属性</li>
<li><code>DOMTokenList</code>类型的属性和方法<ul>
<li><code>length</code>属性：表示含有多少元素，取得每个元素可以使用<code>item()</code>方法或者方括号语法</li>
<li><code>add(value)</code>方法：将给定的字符串添加到列表中，如果已经存在就不添加</li>
<li><code>contains(value)</code>方法：判断列表中是否存在给定的值，存在就返回<code>true</code>，否则返回<code>false</code></li>
<li><code>remove(value)</code>方法：从列表中删除给定的字符串</li>
<li><code>toggle(value)</code>方法：如果列表中存在给定的值，删除他，如果没有就添加。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>焦点管理</strong></p>
<ul>
<li><code>document.activeElement</code>属性<ul>
<li>此属性始终引用<code>DOM</code>中当前获得焦点的元素</li>
<li>元素获得焦点的方式：页面加载，用户输入(通常是按tab键)，在代码中调用<code>focus()</code>方法</li>
<li>默认情况下，文档刚刚加载完成时，保存的是<code>body</code>元素，文档加载期间为<code>null</code></li>
<li>实例  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">      &lt;div tabindex=&quot;0&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">	var div = document.getElementsByTagName(&quot;div&quot;);</span><br><span class="line">	div[0].focus();</span><br><span class="line">	alert(document.activeElement.nodeName);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>document.hasFocus()</code>方法<ul>
<li>用于确定文档是否获得焦点</li>
<li>实例  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">      &lt;div tabindex=&quot;0&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">	var div = document.getElementsByTagName(&quot;div&quot;);</span><br><span class="line">	div[0].focus();</span><br><span class="line">	alert(document.hasFocus());</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p><strong><code>HTMLDocument</code>的变化</strong></p>
<ul>
<li><code>readyState</code>属性<ul>
<li>指示文档加载的状态</li>
<li>可选值：<code>loading</code>表示正在加载文档， <code>complete</code>表示文档加载完成</li>
</ul>
</li>
<li>兼容模式<ul>
<li><code>compatMode</code>属性</li>
<li>指示浏览器渲染页面的模式</li>
<li>可选值：标准模式<code>CSS1Compat</code>，混杂模式<code>BackCompat</code></li>
</ul>
</li>
<li><code>head</code>属性<ul>
<li>用于直接引用<code>head</code>元素</li>
<li>实现此属性的浏览器有<code>Chrome</code>和<code>Safari 5</code></li>
</ul>
</li>
</ul>
<p><strong>字符集属性</strong></p>
<ul>
<li><code>charset</code>属性<ul>
<li><code>document.charset</code>属性，表示文档中实际使用的字符集，也可用来指定新的字符集</li>
<li>所有浏览器都支持</li>
</ul>
</li>
<li><code>defaultCharset</code>属性<ul>
<li><code>document.defaultCharset</code>属性，表示当前文档默认的字符集</li>
<li><code>FireFox</code>不支持</li>
</ul>
</li>
</ul>
<p><strong>自定义数据属性</strong></p>
<ul>
<li>可以为元素添加非标准的属性，但是必须加上前缀<code>data-</code>,用于为元素提供与渲染无关的信息或者提供语义信息。</li>
<li>添加了自定义属性之后可以通过元素的<code>dataset</code>属性来访问自定义属性的值，此时自定义属性的属性名没有<code>data-</code>前缀,此属性还可用于添加自定义属性</li>
<li>实例  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">      &lt;div data-a = &quot;aaaa&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">	var div = document.getElementsByTagName(&quot;div&quot;);</span><br><span class="line">	div[0].dataset.b = &quot;bbbb&quot;;</span><br><span class="line">	alert(div[0].dataset.b);</span><br><span class="line">	alert(div[0].getAttribute(&quot;data-b&quot;));</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>插入标记</strong></p>
<ul>
<li><code>innerHTML</code>属性<ul>
<li>在读模式下，此属性返回与调用元素的所有子节点(包括元素、注释和文本结点)对应的<code>HTML</code>标记</li>
<li>在写模式下，此属性会根据指定的值创建新的<code>DOM</code>树，然后用这个<code>DOM</code>树完全替换调用元素原先的所有子节点</li>
<li>读和写的都是<code>HTML</code>代码</li>
<li>注意：<ul>
<li>有些元素不支持此属性：<code>col,colgroup,frameset,head,html,style,table,tbody,thead,tfoot,tr</code></li>
<li><code>&lt;script&gt;</code>标签不能使用此方法插入</li>
<li><code>&lt;style&gt;</code>标签可以使用此方法插入，但是在IE8以及更早版本中，style是一个没有作用域的元素，插入时必须前置一个有作用域的元素(文本结点或者没有结束标签的元素)  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">div.innerHTML = &quot;_&lt;style type = \&quot;text/css\&quot;&gt;&lt;/style&gt;&quot;;</span><br><span class="line">div.removeChild(div.firstChild);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>实例  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">      读模式</span><br><span class="line">      &lt;div id=&quot;box&quot;&gt;</span><br><span class="line">	&lt;div&gt;aaaa&lt;/div&gt;</span><br><span class="line">	&lt;div&gt;bbbb&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">	var div = document.getElementById(&quot;box&quot;);</span><br><span class="line">	console.log(div.innerHTML);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">//此时输出的是：</span><br><span class="line">                      &lt;div&gt;aaaa&lt;/div&gt;</span><br><span class="line">	            &lt;div&gt;bbbb&lt;/div&gt;</span><br><span class="line">   写模式</span><br><span class="line">   &lt;div id=&quot;box&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">	var div = document.getElementById(&quot;box&quot;);</span><br><span class="line">	div.innerHTML = &quot;&lt;div&gt;aaaa&lt;/div&gt;&lt;div&gt;bbbb&lt;/div&gt;&quot;</span><br><span class="line">	console.log(div.innerHTML);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">//此时会将HTML代码直接写入文档，同时会对相关字符进行转换</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>outerHTML</code>属性<ul>
<li>在读模式下，此属性返回调用它的元素以及所有子节点的<code>HTML</code>标签</li>
<li>在写模式下，此属性会根据指定的<code>HTML</code>字符串创建新的<code>DOM</code>树，然后用这个<code>DOM</code>树完全替换调用元素</li>
<li>具体操作基本同<code>innerHTML</code></li>
</ul>
</li>
<li><code>insertAdjacentHTML()</code>方法<ul>
<li>参数：2个，插入位置，要插入的<code>HTML</code>文本</li>
<li>第一个参数<ul>
<li><code>&quot;beforebegin&quot;</code>：在当前元素之前插入一个紧邻的兄弟元素</li>
<li><code>&quot;afterbegin&quot;</code>：在当前元素之下再插入一个新的子元素，或者在第一个子元素之后再插入一个子元素</li>
<li><code>&quot;beforeend&quot;</code>：在当前元素之下再插入一个新的子元素，或者在最后一个子元素之后再插入新的子元素</li>
<li><code>&quot;afterend&quot;</code>：在当前元素之后插入一个紧邻的兄弟元素</li>
</ul>
</li>
<li>第二个参数<ul>
<li>格式同<code>innerHTML</code></li>
</ul>
</li>
</ul>
</li>
<li>内存与性能问题<ul>
<li>如果元素带有事件处理程序或者引用了一个<code>JS</code>对象作为属性，则使用前述某个属性将该元素从文档树中删除后，元素与事件处理程序或者JS对象之间的绑定关系在内存中并没有删除，因此使用上述属性和方法时最好手动删除</li>
<li>使用上述属性和方法时会创建<code>HTML</code>解析器比直接使用<code>JS</code>要快，但是创建和销毁<code>HTML</code>解析器也会花费时间，因此要将使用次数控制在合理范围内</li>
</ul>
</li>
</ul>
<p><strong><code>scrollIntoView()</code>方法</strong></p>
<ul>
<li>用于控制页面滚动</li>
<li>可以在所有的元素上使用，通过滚动浏览器窗口或者某个容器元素，调用元素就会出现在视口中</li>
<li>如果不传参数或者传true，则会让调用元素的顶部尽可能与视口的顶部平齐</li>
<li>如果传入false，代用元素则会尽可能全部出现在视口中</li>
<li><code>Chrome</code>不支持</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/JS/04.%20%E5%87%BD%E6%95%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱辉">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuhui's yard">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/JS/04.%20%E5%87%BD%E6%95%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-17 21:04:46" itemprop="dateCreated datePublished" datetime="2021-07-17T21:04:46+08:00">2021-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-19 10:26:15" itemprop="dateModified" datetime="2021-06-19T10:26:15+08:00">2021-06-19</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/JS/01.%20JS%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱辉">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuhui's yard">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/JS/01.%20JS%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-17 21:04:46" itemprop="dateCreated datePublished" datetime="2021-07-17T21:04:46+08:00">2021-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-09 21:00:41" itemprop="dateModified" datetime="2021-07-09T21:00:41+08:00">2021-07-09</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-JS基础"><a href="#1-JS基础" class="headerlink" title="1. JS基础"></a>1. JS基础</h1><h2 id="1-1-语法"><a href="#1-1-语法" class="headerlink" title="1.1. 语法"></a>1.1. 语法</h2><h3 id="1-1-1-基础"><a href="#1-1-1-基础" class="headerlink" title="1.1.1. 基础"></a>1.1.1. 基础</h3><ul>
<li>JS中的一切都是区分大小写的，并且使用Unicode字符集</li>
<li>标识符规则<ul>
<li>第一个字符必须是一个字母、下划线或者<code>$</code>美元符号</li>
<li>其他字符可以是字母、下划线、美元符号或者数字<h3 id="1-1-2-语句"><a href="#1-1-2-语句" class="headerlink" title="1.1.2. 语句"></a>1.1.2. 语句</h3></li>
</ul>
</li>
<li>是执行行为的语法结构和命令</li>
<li>语句规则<ul>
<li>使用<code>;</code>进行分割，通常每条语句独占一行，提高代码的可读性。</li>
<li>如果一条语句独占一行，那么分号可以省略，但是并不推荐此种写法，因为容易出错，同时加上分号也有助于提高代码性能。</li>
<li>JS通常会将换行解释为分号，但是也存在无法确定是否真的需要插入的情况</li>
</ul>
</li>
<li>实例<ul>
<li>换行但不是分号  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">     alert(1+</span><br><span class="line">2+</span><br><span class="line">3);</span><br><span class="line">  //此时每一行是不完整的表达式，不需要分号</span><br></pre></td></tr></table></figure></li>
<li>无法确定是否真的需要插入  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">      alert(&quot;There will be an error&quot;)</span><br><span class="line">[1,2].forEach(alert);</span><br><span class="line">//JS不会在[...]之前自动添加分号，所以此时会报错</span><br></pre></td></tr></table></figure>
<h3 id="1-1-3-注释"><a href="#1-1-3-注释" class="headerlink" title="1.1.3. 注释"></a>1.1.3. 注释</h3></li>
</ul>
</li>
<li>单行注释<ul>
<li><code>\\</code></li>
</ul>
</li>
<li>多行注释<ul>
<li><code>\*...*\</code></li>
</ul>
</li>
<li>注意<ul>
<li>不支持嵌套注释<h2 id="1-2-现代模式"><a href="#1-2-现代模式" class="headerlink" title="1.2. 现代模式"></a>1.2. 现代模式</h2></li>
</ul>
</li>
<li>也称为严格模式</li>
<li>JS新的规范修改了一些特性，为了保证旧的功能能够使用，大部分的修改默认不生效，需要一个指令<code>&quot;use strict&quot;</code>来激活这些特性</li>
<li>严格模式使用<code>&quot;use strict&quot;</code>启用<ul>
<li>此命令必须放在脚本的最顶部，其上只能有注释，否则无法正常启用严格模式</li>
<li>此命令可以被放在函数体的开头，只在该函数中启用严格模式</li>
<li>严格模式一旦启用，无法取消</li>
<li>现代JS支持<code>classes</code>和<code>modules</code>高级语言结构，他们会自动启用严格模式。因此，如果代码写在了高级语言结构中，就不需要显式的启用严格模式<h2 id="1-3-变量"><a href="#1-3-变量" class="headerlink" title="1.3. 变量"></a>1.3. 变量</h2><h3 id="1-3-1-声明变量"><a href="#1-3-1-声明变量" class="headerlink" title="1.3.1. 声明变量"></a>1.3.1. 声明变量</h3></li>
</ul>
</li>
<li>三种方式<ul>
<li>使用关键字<code>var</code>，用于声明局部变量和全局变量。</li>
<li>直接赋值。在函数外使用此方法会产生一个全局变量。严格模式下会报错，因此不建议使用</li>
<li>使用关键字<code>let</code>，用于声明块作用域的局部变量。</li>
</ul>
</li>
<li><code>let</code>和<code>var</code>的区别<ul>
<li><code>var</code>声明的变量没有块级作用域，只有全局作用域和函数级作用域。</li>
<li><code>var</code>声明的变量允许重新声明而不会报错。</li>
<li><code>var</code>声明的变量在函数开头和全局作用域开头就会被声明，称为变量提升，但是赋值操作不会提升。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="literal">false</span>)&#123;</span><br><span class="line">	<span class="keyword">var</span> a = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line">alert(a);</span><br></pre></td></tr></table></figure>

此时输出<code>undefined</code>,变量的声明被提前(忽略块作用域)，但是赋值操作不会被提前。赋值之前都是<code>undefined</code>。</li>
<li><code>let</code>也会提升，但是在变量声明在之前引用会报错，因此相当于不提升。</li>
<li><a target="_blank" rel="noopener" href="https://zh.javascript.info/var">var和let的区别</a><h3 id="1-3-2-变量性质"><a href="#1-3-2-变量性质" class="headerlink" title="1.3.2. 变量性质"></a>1.3.2. 变量性质</h3></li>
</ul>
</li>
<li>JS中的变量是松散类型的，可以保存任何类型的数据，每个变量仅仅是一个用于保存值的占位符。变量相当于一个箱子，内部可以装任何类型的数据。</li>
<li>一个变量只能声明一次，否则会报错。变量最好先声明再使用。</li>
<li>用<code>var</code>或者<code>let</code>声明的语句如果没有初始化，则其值为<code>undefined</code>。</li>
<li><code>let</code>声明的变量具有块作用域，和<code>var</code>不同</li>
<li>变量命名<ul>
<li>遵循标识符的规则</li>
<li>变量名称必须仅包含字母、数字、美元符号<code>$</code>和<code>_</code></li>
<li>首字符必须是非数字字符</li>
<li>变量名称可以使用任何语言字符，包括中文，但是不推荐</li>
</ul>
</li>
<li>全局变量<ul>
<li><code>JS</code>中使用<code>var</code>和<code>function</code>声明的全局变量是顶层对象的属性。网页中默认顶层对象为<code>window</code>对象，因此可以使用<code>window.a</code>的语法来设置和访问全局变量。</li>
<li><code>let</code>、<code>const</code>、<code>class</code>不适用上述规则，其声明的全局变量不是顶层对象的属性，而是属于全局作用域<code>scope</code>的<code>script</code>。</li>
</ul>
</li>
<li>实例<ul>
<li>变量的声明和赋值  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line"><span class="keyword">let</span> b = <span class="number">1</span>,c = <span class="string">&#x27;a&#x27;</span>,d = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">//可以在一行中声明多个变量</span></span><br></pre></td></tr></table></figure></li>
<li>使用中文变量名称  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> 朱辉 = <span class="string">&#x27;zhuhui&#x27;</span>;</span><br><span class="line"><span class="comment">//不推荐使用此方式</span></span><br></pre></td></tr></table></figure>
<h2 id="1-4-常量"><a href="#1-4-常量" class="headerlink" title="1.4. 常量"></a>1.4. 常量</h2></li>
</ul>
</li>
<li>声明  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PI = <span class="number">3.14</span>;</span><br><span class="line"><span class="comment">//不能使用let</span></span><br></pre></td></tr></table></figure></li>
<li>特点<ul>
<li>常量标识符命名规则和变量相同。全大写命名常用于常量在程序执行之前就确定的情况，其他情况使用常规命名。</li>
<li>常量不可以通过重新赋值改变其值，也不可以重新声明。重新赋值会报错</li>
<li>常量的作用域规则同样是块级作用域，与<code>let</code>相同</li>
<li>常量必须在声明的时候赋值，之后无法修改  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">const</span> a;</span><br><span class="line">a = <span class="number">10</span>;</span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br><span class="line"><span class="comment">//此时会报错</span></span><br></pre></td></tr></table></figure></li>
<li>同一作用域中，常量名、变量名、函数名不能相同，否则会报错  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="keyword">const</span> f = <span class="number">10</span>;</span><br></pre></td></tr></table></figure></li>
<li>未赋值的常量不会被赋予默认值  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">const</span> a;</span><br><span class="line">alert(a);</span><br><span class="line"><span class="comment">//此时会报错</span></span><br></pre></td></tr></table></figure></li>
<li>对象或者数组被定义为常量，其值不受保护，可以自由改变，此操作没有意义  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">const</span> person = &#123;</span><br><span class="line">	<span class="attr">name</span>:<span class="string">&#x27;zhuhui&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line">person.name = <span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line"><span class="built_in">console</span>.log(person.name);</span><br><span class="line"><span class="comment">//此时不会报错，数组同样</span></span><br></pre></td></tr></table></figure>
<h2 id="1-5-数据类型"><a href="#1-5-数据类型" class="headerlink" title="1.5. 数据类型"></a>1.5. 数据类型</h2><h3 id="1-5-1-概览"><a href="#1-5-1-概览" class="headerlink" title="1.5.1. 概览"></a>1.5.1. 概览</h3></li>
</ul>
</li>
<li>七种基本数据类型<ul>
<li>布尔值<code>Boolean</code>：有两个值<code>true</code>和<code>false</code></li>
<li><code>null</code>：表明<code>null</code>值的特殊关键字，注意是小写</li>
<li><code>undefined</code>：表明变量未赋值的特殊关键字，也是小写</li>
<li>数字<code>Number</code>：整数或者浮点数</li>
<li>任意精度的整数<code>BigInt</code>：可以安全的存储和操作大整数</li>
<li>字符串<code>String</code>：一串表示文本值的字符序列</li>
<li>代表<code>Symbol</code>：一种实例是唯一的并且不可改变的数据类型</li>
</ul>
</li>
<li>一种引用类型<ul>
<li>对象<code>Object</code></li>
</ul>
</li>
<li>动态类型<ul>
<li><code>JS</code>是一种动态类型的语言，在声明变量的时候不用指定数据的类型，数据类型会在代码执行时根据需要自定确定和转换。可以在任何时刻将任何类型的值存入某一变量中。<h2 id="1-6-字面量（Literals）"><a href="#1-6-字面量（Literals）" class="headerlink" title="1.6. 字面量（Literals）"></a>1.6. 字面量（Literals）</h2><h3 id="1-6-1-概述"><a href="#1-6-1-概述" class="headerlink" title="1.6.1. 概述"></a>1.6.1. 概述</h3></li>
</ul>
</li>
<li>字面量是由语法表达式定义的常量，或者是由一定字词组成的语词表达式定义的常量。</li>
<li>注意字面量是脚本中按照字面意思给出的固定的值，是常量，不是变量，在程序运行过程中不可更改。</li>
<li>是直接写在代码中的，常用作变量的赋值的常量<h3 id="1-6-2-数组字面量"><a href="#1-6-2-数组字面量" class="headerlink" title="1.6.2. 数组字面量"></a>1.6.2. 数组字面量</h3></li>
<li>是在<code>[]</code>中包含的零个或者多个表达式的列表，每个表达式代表数组的一个元素。数组字面量同时也是数组对象。</li>
<li>当使用数组字面量创建数组时，数组会以指定的值作为其元素进行初始化，数组长度即为元素的个数。</li>
<li>如果在全局脚本里使用字面量创建数组，<code>JS</code>会在每次对包含该数组字面量的表达式求值时解释该数组。在函数中使用的字面量会在函数每次执行时被重新创建。</li>
<li>使用数组字面量创建数组  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = [<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line"><span class="comment">//创建数组，长度为3</span></span><br></pre></td></tr></table></figure></li>
<li>多余逗号的处理  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//两个逗号连起来并且不在数组末尾，表示省略了一个元素，此元素会被默认赋值为undefined</span></span><br><span class="line"><span class="keyword">let</span> a = [<span class="string">&#x27;a&#x27;</span>,,<span class="string">&#x27;c&#x27;</span>];        <span class="comment">//此时a[1] = undefined</span></span><br><span class="line"><span class="comment">//位于末尾的最后一个逗号会被忽略</span></span><br><span class="line"><span class="keyword">let</span> a = [<span class="string">&#x27;a&#x27;</span>,,<span class="string">&#x27;c&#x27;</span>,];       <span class="comment">//此时a.length = 3</span></span><br><span class="line"><span class="comment">//只有最后一个逗号会被忽略</span></span><br><span class="line"><span class="keyword">let</span> a = [<span class="string">&#x27;a&#x27;</span>,,<span class="string">&#x27;c&#x27;</span>,,];      <span class="comment">//此时相当于let a = [&#x27;a&#x27;,,&#x27;c&#x27;,];    //数组长度等于有效逗号数量加1</span></span><br></pre></td></tr></table></figure>
<h3 id="1-6-3-逻辑字面量"><a href="#1-6-3-逻辑字面量" class="headerlink" title="1.6.3. 逻辑字面量"></a>1.6.3. 逻辑字面量</h3></li>
<li>两个值：<code>true</code>和<code>false</code></li>
<li>注意<ul>
<li>原始布尔类型的<code>true</code>和<code>false</code>和布尔对象的<code>true</code>和<code>false</code>是不同的。布尔对象是对原始数据类型的封装<h3 id="1-6-4-整数字面量"><a href="#1-6-4-整数字面量" class="headerlink" title="1.6.4. 整数字面量"></a>1.6.4. 整数字面量</h3></li>
</ul>
</li>
<li>整数可以是十进制、十六进制、八进制、二进制，几种进制的表示方式不同</li>
<li>规则<ul>
<li>十进制整数字面量是一串数字序列，没有前缀<code>0</code></li>
<li>八进制整数字面量以<code>0</code>或者<code>0O</code>和<code>0o</code>开头，只能有数字<code>0-7</code>。严格模式下不能以<code>0</code>开头</li>
<li>十六进制整数字面量以<code>0x</code>或者<code>0X</code>开头，只能包含数字<code>0-9</code>，字母<code>a-f|A-F</code></li>
<li>二进制整数字面量以<code>0b</code>或者<code>0B</code>开头，只能包含数字<code>0</code>和<code>1</code><h3 id="1-6-5-浮点数字面量"><a href="#1-6-5-浮点数字面量" class="headerlink" title="1.6.5. 浮点数字面量"></a>1.6.5. 浮点数字面量</h3></li>
</ul>
</li>
<li>浮点数字面量的组成部分<ul>
<li>一个十进制整数，可以带正负号</li>
<li>小数点</li>
<li>小数部分</li>
<li>指数部分</li>
</ul>
</li>
<li>规则<ul>
<li>指数部分以<code>e</code>或者<code>E</code>开头，后面跟着一个整数，可以有正负号。</li>
<li>浮点数字面量至少有一位数字，并且必须带小数点<code>.</code>或者<code>e|E</code>。</li>
<li>小数点之前或者之后只有数字<code>0</code>时，<code>0</code>可以省略，但是要注意至少有一位数字。</li>
</ul>
</li>
<li>实例  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">.3</span>            <span class="comment">//0.3</span></span><br><span class="line"> <span class="number">3.1e-12</span></span><br><span class="line"></span><br><span class="line"> <span class="number">3.</span>            <span class="comment">//3.0</span></span><br></pre></td></tr></table></figure>
<h3 id="1-6-6-对象字面量"><a href="#1-6-6-对象字面量" class="headerlink" title="1.6.6. 对象字面量"></a>1.6.6. 对象字面量</h3></li>
<li>对象字面量是封闭在<code>&#123;&#125;</code>中的一个对象的零个或者多个<code>属性名-值</code>对的列表</li>
<li>注意<ul>
<li>对象字面量不能直接放在语句的开头，因为会被认为是一个语句块。</li>
</ul>
</li>
<li>可以使用数字或者字符串字面值作为属性的名字,还可以在一个字面值里嵌套另一个字面值。  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = &#123;<span class="attr">b</span>:&#123;<span class="attr">c</span>:<span class="number">4</span>,<span class="number">7</span>:<span class="string">&#x27;d&#x27;</span>&#125;,<span class="attr">e</span>:<span class="string">&quot;f&quot;</span>&#125;;</span><br></pre></td></tr></table></figure></li>
<li>属性名可以是任意字符串，甚至空串。如果对象属性名不是数字或者字符串就必须使用<code>&quot;&quot;</code>包裹。访问和修改时使用<code>[]</code>。  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">let</span> a = &#123;</span><br><span class="line">       <span class="string">&quot;&quot;</span>:<span class="number">10</span>,</span><br><span class="line">       <span class="string">&quot;!&quot;</span>:<span class="number">20</span>,</span><br><span class="line">       <span class="number">10</span>:<span class="number">30</span></span><br><span class="line">   &#125;;</span><br><span class="line">   <span class="built_in">console</span>.log(a[<span class="string">&quot;&quot;</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(a[<span class="string">&quot;!&quot;</span>]);</span><br><span class="line">   <span class="built_in">console</span>.log(a[<span class="number">10</span>]);</span><br></pre></td></tr></table></figure>
<h3 id="1-6-7-正则表达式字面量"><a href="#1-6-7-正则表达式字面量" class="headerlink" title="1.6.7. 正则表达式字面量"></a>1.6.7. 正则表达式字面量</h3></li>
<li>字符被斜线围成的表达式  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="regexp">/ab+c/</span>;</span><br></pre></td></tr></table></figure>
<h3 id="1-6-8-字符串字面量"><a href="#1-6-8-字符串字面量" class="headerlink" title="1.6.8. 字符串字面量"></a>1.6.8. 字符串字面量</h3></li>
<li>由双引号<code>&quot;&quot;</code>或者单引号<code>&#39;&#39;</code>括起来的零个或者多个字符。引号要配对，不能混用。</li>
<li>可以在字符串字面量上使用所有的字符串对象方法，<code>JS</code>会自动将字符串字面量转换为一个临时的字符串对象，调用方法之后再将临时对象废弃。  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;length&quot;</span>.length);</span><br><span class="line"><span class="comment">//输出为6</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="1-7-语句"><a href="#1-7-语句" class="headerlink" title="1.7. 语句"></a>1.7. 语句</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/JS/02%20.%20JS%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱辉">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuhui's yard">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/JS/02%20.%20JS%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-17 21:04:46" itemprop="dateCreated datePublished" datetime="2021-07-17T21:04:46+08:00">2021-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-19 10:26:15" itemprop="dateModified" datetime="2021-06-19T10:26:15+08:00">2021-06-19</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>527</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-JS数据类型"><a href="#1-JS数据类型" class="headerlink" title="1. JS数据类型"></a>1. JS数据类型</h1><h2 id="1-1-Number类型"><a href="#1-1-Number类型" class="headerlink" title="1.1. Number类型"></a>1.1. Number类型</h2><ul>
<li>代表整型或者浮点型</li>
<li>在<code>JS</code>中作数学运算是安全的，脚本永远不会因为一个错误而停止，最坏情况下会得到<code>NAN</code>。</li>
<li>一些特殊数值也是此类型，但是一般认为他们不是数字<ul>
<li><code>Infinity</code><ul>
<li>表示无穷大<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> b = <span class="literal">Infinity</span>;</span><br><span class="line"><span class="comment">//二者的结果都是Infinity</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>-Infinity</code></li>
<li><code>NAN</code><ul>
<li>代表计算错误，是一个不正确的或者未定义的数学操作得到的结果，并且任何对<code>NAN</code>的进一步操作都会得到<code>NAN</code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="string">&#x27;a&#x27;</span>/<span class="number">2</span>;</span><br><span class="line"><span class="keyword">let</span> b = <span class="string">&#x27;a&#x27;</span>/<span class="number">2</span>+<span class="number">3</span>;</span><br><span class="line"><span class="comment">//二者的结构都是NAN</span></span><br></pre></td></tr></table></figure>
<h2 id="1-2-BigInt类型"><a href="#1-2-BigInt类型" class="headerlink" title="1.2. BigInt类型"></a>1.2. BigInt类型</h2></li>
</ul>
</li>
</ul>
</li>
<li>在<code>JS</code>中<code>Number</code>无法表示大于$(2^{53}-1)$或者小于$-(2^{53}-1)$的整数</li>
<li><code>BigInt</code>用于表示任意长度的<code>整数</code></li>
<li><code>Firefox</code>、<code>Chrome</code>和<code>Edge</code>已经支持<code>BigInt</code>类型了，其他浏览器暂不支持</li>
<li>创建<code>BigInt</code>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> bigint = <span class="number">9999999999999999999999999999999999999999999999999999999999999999999999n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(bigint);</span><br><span class="line"><span class="comment">//数字末尾添加n表示是BigInt类型的值</span></span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/JS/05.%20%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱辉">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuhui's yard">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/JS/05.%20%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-17 21:04:46" itemprop="dateCreated datePublished" datetime="2021-07-17T21:04:46+08:00">2021-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-10 12:29:51" itemprop="dateModified" datetime="2021-07-10T12:29:51+08:00">2021-07-10</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-面向对象程序设计-属性类型"><a href="#1-面向对象程序设计-属性类型" class="headerlink" title="1. 面向对象程序设计-属性类型"></a>1. 面向对象程序设计-属性类型</h1><ul>
<li>JS中没有类的概念，其中的对象也与其他面向对象的语言中的对象不同</li>
<li>JS中的对象是无序属性的集合，属性可以包含基本值、对象或者函数，可以视为散列表</li>
<li>每个对象基于一个引用类型创建，此引用类型可以是原生类型，也可以是自定义的类型<h2 id="1-1-理解对象"><a href="#1-1-理解对象" class="headerlink" title="1.1. 理解对象"></a>1.1. 理解对象</h2><h3 id="1-1-1-属性类型"><a href="#1-1-1-属性类型" class="headerlink" title="1.1.1. 属性类型"></a>1.1.1. 属性类型</h3><h4 id="1-1-1-1-基本概念"><a href="#1-1-1-1-基本概念" class="headerlink" title="1.1.1.1. 基本概念"></a>1.1.1.1. 基本概念</h4></li>
<li>属性的特性是用于实现JS引擎的，不能直接访问他们</li>
<li>为了表示这些特性是内部值，规范规定把他们放在两对方括号中</li>
<li>表示属性的属性？<h4 id="1-1-1-2-数据属性"><a href="#1-1-1-2-数据属性" class="headerlink" title="1.1.1.2. 数据属性"></a>1.1.1.2. 数据属性</h4></li>
<li>包含一个数据值的位置，在这个位置可以读取和写入值。数据属性有四个描述其行为的特征，也称为属性标志。</li>
<li>特征<ul>
<li><code>[[Configurable]]</code><ul>
<li>能否通过<code>delete</code>删除属性，从而重新定义属性。</li>
<li>能否修改属性的特性。</li>
<li>能否将属性修改为访问器属性。</li>
<li>一般属性此特性默认为<code>true</code></li>
</ul>
</li>
<li><code>[[Enumerable]]</code><ul>
<li>能否通过<code>for-in</code>循环返回属性。</li>
<li>一般默认为<code>true</code></li>
</ul>
</li>
<li><code>[[Writable]]</code><ul>
<li>能否修改属性的值</li>
<li>一般默认为<code>true</code></li>
</ul>
</li>
<li><code>[[Value]]</code><ul>
<li>包含属性的数据值</li>
<li>读取和写入都是从此位置</li>
<li>默认为<code>undefined</code></li>
</ul>
</li>
</ul>
</li>
<li>举例  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&quot;zhuhui&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//此时[[Configurable]] = [[Enumerable]] = [[Writable]] = true,[[Value]] = &quot;zhuhui&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>修改属性默认的特性<ul>
<li>使用<code>Objecct.defineProperty()</code>方法</li>
<li>参数：3个，属性所在的对象、属性的名字（用双引号引起来）、一个描述符对象（其属性必须是属性的特性，设置其中一个或者多个值）</li>
<li>注意<ul>
<li>将<code>[[Configurable]]</code>设置为<code>false</code>之后，将无法再对其特性进行修改。</li>
<li>如果修改时不指定，则<code>[[Configurable]]、[[Enumerable]]、[[Writable]]</code>默认值为<code>false</code></li>
<li>注意，不可配置只是值不能对属性的标志进行修改，但是属性的读写不受影响。</li>
</ul>
</li>
<li>实例  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;&#125;;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(person,<span class="string">&quot;name&quot;</span>,&#123;</span><br><span class="line">    <span class="attr">writable</span>:<span class="literal">false</span>,</span><br><span class="line">    <span class="attr">value</span>:<span class="string">&quot;zhuhui&quot;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//此时name属性的值是只读的，非严格模式下的赋值操作将被忽略，严格模式将报错</span></span><br></pre></td></tr></table></figure>
<h4 id="1-1-1-3-访问器属性"><a href="#1-1-1-3-访问器属性" class="headerlink" title="1.1.1.3. 访问器属性"></a>1.1.1.3. 访问器属性</h4></li>
</ul>
</li>
<li>不包含数据值，包含一对<code>getter</code>和<code>setter</code>，分别在读取和写入时调用。</li>
<li>特性<ul>
<li><code>[[Configurable]]</code><ul>
<li>能否通过<code>delete</code>删除属性，从而重新定义属性。</li>
<li>能否修改属性的特性。</li>
<li>能否将属性修改为数据属性。</li>
<li>一般属性此特性默认为<code>true</code></li>
</ul>
</li>
<li><code>[[Enumerable]]</code><ul>
<li>能否通过<code>for-in</code>循环返回属性。</li>
<li>一般默认为<code>true</code></li>
</ul>
</li>
<li><code>[[Get]]</code><ul>
<li>在读取属性时调用的函数</li>
<li>默认为<code>undefined</code></li>
</ul>
</li>
<li><code>[[Set]]</code><ul>
<li>在写入属性时调用的函数</li>
<li>默认为<code>undefined</code></li>
</ul>
</li>
</ul>
</li>
<li>实例  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> person = &#123;</span><br><span class="line">	<span class="attr">_year</span>:<span class="number">10</span>,</span><br><span class="line">	<span class="attr">name</span>:<span class="string">&quot;zhuhui&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(person,<span class="string">&quot;year&quot;</span>,&#123;</span><br><span class="line">	<span class="attr">get</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>._year;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">set</span>:<span class="function"><span class="keyword">function</span>(<span class="params">newValue</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(newValue&gt;<span class="number">10</span>)&#123;</span><br><span class="line">			<span class="built_in">this</span>._year = newValue;</span><br><span class="line">			<span class="built_in">this</span>.name = <span class="string">&quot;aaa&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li>注意<ul>
<li>属性前的<code>_</code>是一种常用记号，表示只能通过对象方法访问的属性。在定义<code>setter</code>和<code>getter</code>函数时，需要使用带<code>_</code>的名称，其他情况下使用不带下划线的。</li>
<li>访问器属性不能直接定义，必须通过<code>Object.defineProperty()</code>方法定义，参数同上。</li>
<li>不同时指定<code>getter</code>和<code>setter</code>函数，则意味着属性不能读或者不能写。</li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/71780882">getter和setter的最新特性及优势</a></li>
</ul>
</li>
</ul>
<h3 id="1-1-2-定义多个属性"><a href="#1-1-2-定义多个属性" class="headerlink" title="1.1.2. 定义多个属性"></a>1.1.2. 定义多个属性</h3><ul>
<li><code>Object.defineProperties()</code>方法<ul>
<li>参数：两个对象参数，第一个是要添加和修改属性的对象，第二个对象的属性和第一个对象中要添加或者修改的属性一一对应<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> book = &#123;&#125;;</span><br><span class="line"><span class="built_in">Object</span>.defineProperties(book,&#123;</span><br><span class="line">	<span class="attr">_year</span>:&#123;</span><br><span class="line">		<span class="attr">value</span>:<span class="number">2004</span>;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">edition</span>:&#123;</span><br><span class="line">		<span class="attr">value</span>:<span class="number">1</span>;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">year</span>:&#123;</span><br><span class="line">		<span class="attr">get</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>._year;</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">set</span>:<span class="function"><span class="keyword">function</span>(<span class="params">newValue</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(newValue&gt;<span class="number">2004</span>)&#123;</span><br><span class="line">				<span class="built_in">this</span>._year = newValue;</span><br><span class="line">				<span class="built_in">this</span>.edition += newValue-<span class="number">2004</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line">   <span class="comment">//属性存在则修改其标志，不存在则创建</span></span><br></pre></td></tr></table></figure>
<h3 id="1-1-3-读取属性的特性"><a href="#1-1-3-读取属性的特性" class="headerlink" title="1.1.3. 读取属性的特性"></a>1.1.3. 读取属性的特性</h3></li>
</ul>
</li>
<li><code>Object.getOwnPropertyDescriptor()</code>方法<ul>
<li>取得给定属性的描述符</li>
<li>参数：两个，属性所在的对象，想要取得其描述符的属性名称（必须用引号括起来）</li>
<li>返回值：一个对象</li>
<li>注意：只能取得实例属性的描述符，想要取得原型属性的描述符，必须在原型属性上调用。下同<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> person = &#123;</span><br><span class="line">	<span class="attr">name</span>:<span class="string">&quot;zhuhui&quot;</span>,</span><br><span class="line">	<span class="attr">year</span>:<span class="number">20</span>,</span><br><span class="line">	<span class="attr">location</span>:<span class="string">&quot;xian&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> a = <span class="built_in">Object</span>.getOwnPropertyDescriptor(person,<span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(a.writable);</span><br><span class="line"><span class="comment">//如果是数据属性，返回对象的属性为数据属性的四个特性，get和set为undefined</span></span><br><span class="line"><span class="comment">//如果是访问器属性，返回对象的属性为访问器输属性的四个特性，value和writeable是undefined，setter和getter返回的是函数的指针</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>Object.getOwnPropertyDescriptors()</code>方法<ul>
<li>取得对象所有属性的描述符</li>
<li>参数：1个，想要获得属性的对象</li>
<li>返回值：一个对象<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> person = &#123;</span><br><span class="line">	<span class="attr">name</span>:<span class="string">&quot;zhuhui&quot;</span>,</span><br><span class="line">	<span class="attr">year</span>:<span class="number">20</span>,</span><br><span class="line">	<span class="attr">location</span>:<span class="string">&quot;xian&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> a = <span class="built_in">Object</span>.getOwnPropertyDescriptor(person);</span><br><span class="line"><span class="built_in">console</span>.log(a)</span><br></pre></td></tr></table></figure>
<h2 id="1-2-创建对象"><a href="#1-2-创建对象" class="headerlink" title="1.2. 创建对象"></a>1.2. 创建对象</h2><h3 id="1-2-1-工厂模式"><a href="#1-2-1-工厂模式" class="headerlink" title="1.2.1. 工厂模式"></a>1.2.1. 工厂模式</h3></li>
</ul>
</li>
<li>抽象了创建具体对象的过程，用函数封装以特定接口屏蔽创建对象的细节</li>
<li>特点<ul>
<li>解决了创建多个相似对象的问题，但是没有解决对象识别的问题</li>
</ul>
</li>
<li>实例  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">creatPerson</span>(<span class="params">name,age,job</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">let</span> o = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">	o.name = name;</span><br><span class="line">	o.age = age;</span><br><span class="line">	o.job = job;</span><br><span class="line">	o.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		alert(<span class="built_in">this</span>.name);</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> person1 = creatPerson(<span class="string">&quot;zhuhui&quot;</span>,<span class="number">20</span>,<span class="string">&quot;student&quot;</span>);</span><br><span class="line"><span class="comment">//可以无数次的调用此函数，返回特定的对象。</span></span><br></pre></td></tr></table></figure>
<h3 id="1-2-2-构造函数模式"><a href="#1-2-2-构造函数模式" class="headerlink" title="1.2.2. 构造函数模式"></a>1.2.2. 构造函数模式</h3></li>
<li>构造函数可以用于创建引用类型的对象，也可以用于创建自定义类型的对象</li>
<li>以此种方式构造的构造函数是定义在全局作用域中的，是<code>window</code>对象的方法</li>
<li>创建步骤<ul>
<li>创建一个构造函数定义对象的类型。构造函数的首字母通常大写。<code>JS</code>中的构造函数和<code>C++</code>等中的构造函数类似，只不过没有类这个概念。</li>
<li>使用<code>new</code>创建对象实例</li>
</ul>
</li>
<li>实例  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name,age,job</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">this</span>.name = name;</span><br><span class="line">	<span class="built_in">this</span>.age = age;</span><br><span class="line">	<span class="built_in">this</span>.job = job;</span><br><span class="line">	<span class="built_in">this</span>.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		alert(<span class="built_in">this</span>.name);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> person1 = <span class="keyword">new</span> Person(<span class="string">&quot;zhuhui&quot;</span>,<span class="number">20</span>,<span class="string">&quot;student&quot;</span>);</span><br></pre></td></tr></table></figure></li>
<li>构造函数被调用时执行以下步骤<ul>
<li>创建一个新的空对象</li>
<li>将构造函数的作用域赋给新对象，即为将<code>this</code>指向新对象</li>
<li>执行函数体，为对象添加属性和方法</li>
<li>返回<code>this</code>的值</li>
<li>可以近似的视为以下过程  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name,age,job</span>)</span>&#123;</span><br><span class="line">       <span class="built_in">this</span> = &#123;&#125;;    <span class="comment">//隐式创建空对象，并赋给this</span></span><br><span class="line">	<span class="built_in">this</span>.name = name;</span><br><span class="line">	<span class="built_in">this</span>.age = age;</span><br><span class="line">	<span class="built_in">this</span>.job = job;</span><br><span class="line">	<span class="built_in">this</span>.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		alert(<span class="built_in">this</span>.name);</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">this</span>;        <span class="comment">//隐式的返回对象</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> person1 = <span class="keyword">new</span> Person(<span class="string">&quot;zhuhui&quot;</span>,<span class="number">20</span>,<span class="string">&quot;student&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>constructor</code>属性<ul>
<li>使用构造函数创建的对象其<code>constructor</code>属性值为其构造函数</li>
<li>对象的<code>constructor</code>属性可以用于标识对象的类型。</li>
<li><code>instanceof</code>操作符也可用于标识对象的类型，用构造函数创建的对象既是<code>Object</code>的实例，也是其构造函数定义类型的实例</li>
</ul>
</li>
<li>构造函数和函数<ul>
<li>构造函数和普通函数没有本质区别，二者唯一的区别在于调用的方式不同</li>
<li>构造函数既可以用构造函数的方式调用，也可以用普通函数的方式调用  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">let</span> person1 = <span class="keyword">new</span> Person(<span class="string">&quot;zhuhui&quot;</span>,<span class="number">20</span>,<span class="string">&quot;student&quot;</span>);</span><br><span class="line">Person(<span class="string">&quot;a&quot;</span>,<span class="number">10</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line"><span class="built_in">window</span>.sayName();</span><br><span class="line"><span class="comment">//将构造函数作为普通函数调用，严格模式下会报错，不推荐使用</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>构造函数的问题<ul>
<li>使用构造函数构造对象，则每个方法都要在每个对象上重新创建一遍</li>
<li>不同的对象拥有不同的方法实例，但是这些方法完成的任务是相同的</li>
<li>此种方法导致不同的作用域链和标识符解析</li>
<li>解决方法  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">//将函数的定义转移到构造函数外部</span></span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name,age,job</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">this</span>.name = name;</span><br><span class="line">	<span class="built_in">this</span>.age = age;</span><br><span class="line">	<span class="built_in">this</span>.job = job;</span><br><span class="line">	<span class="built_in">this</span>.sayName = sayName;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayName</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	alert(<span class="built_in">this</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//但是此种方法严重破坏了封装性，因此需要使用原型模式来解决</span></span><br></pre></td></tr></table></figure>
<h3 id="1-2-3-原型模式"><a href="#1-2-3-原型模式" class="headerlink" title="1.2.3. 原型模式"></a>1.2.3. 原型模式</h3></li>
</ul>
</li>
<li>理解原型对象<ul>
<li>当创建新函数时，会根据一组特定的规则为函数创建一个<code>prototype</code>属性，此属性指向函数的原型对象</li>
<li>原型对象有一个<code>constructor</code>属性，此属性包含一个指向<code>prototype</code>属性所属函数的指针</li>
<li>当使用构造函数创建一个对象之后，此对象内部将包含一个指针，指向构造函数的原型对象。此指针叫做<code>[[Prototype]]</code></li>
<li>对象可以使用属性<code>_proto_</code>访问原型对象，<code>_proto_</code>是<code>[[Prototype]]</code>的<code>getter</code>和<code>setter</code></li>
<li>此连接存在于实例对象和构造函数的原型对象之间，而不是实例与构造函数之间</li>
</ul>
</li>
<li>为原型对象添加属性和方法  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">Person.prototype.name = <span class="string">&quot;zhuhui&quot;</span>;</span><br><span class="line">Person.prototype.age = <span class="number">20</span>;</span><br><span class="line">Person.prototype.job = <span class="string">&quot;students&quot;</span>;</span><br><span class="line">Person.prototype.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	alert(<span class="built_in">this</span>.name);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//直接使用构造函数的prototype属性进行添加即可</span></span><br><span class="line"><span class="comment">//原型对象默认只包含constructor属性，其他属性都是之后添加的</span></span><br></pre></td></tr></table></figure></li>
<li>访问对象的<code>[[Prototype]]</code>属性<ul>
<li>没有标准的方式可以访问此属性，但是有相关的方法可以间接访问</li>
<li><code>isPrototypeof()</code>方法<ul>
<li>确定构造函数的原型对象是否是某一对象的原型对象</li>
<li>参数：1个，实例对象</li>
<li>实例  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Person.prototype.isPrototypeOf(person1)</span><br><span class="line"><span class="comment">//Person构造函数的原型对象是否是person1对象的原型对象</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>Object.getPrototypeof()</code><ul>
<li>返回对象的原型对象</li>
<li>参数：1个，实例对象</li>
<li>实例  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Object.getPrototypeOf(person1)</span><br><span class="line">//返回对象的原型对象</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li>调用对象的属性和方法<ul>
<li>当调用对象的属性和方法时，会先从对象实例本身开始搜索，如果找到，则返回。如果没找到，则搜索对象的原型对象，如果找到则返回。</li>
<li>无法通过对象重写原型对象中的值，对象中和原型对象重名的属性和方法只会屏蔽原型对象的属性和方法。</li>
<li>使用<code>delete</code>可以删除实例属性，从而能够重新访问原型对象中的属性和方法</li>
<li><code>hasOwnProperty()</code>方法<ul>
<li>用于检测一个属性存在于实例中还是原型对象中</li>
<li>参数：1个，属性名</li>
<li>返回值：当属性存在于对象实例中时，返回<code>true</code>，否则返回<code>false</code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">Person.prototype.name = <span class="string">&quot;zhuhui&quot;</span>;</span><br><span class="line">Person.prototype.age = <span class="number">20</span>;</span><br><span class="line">Person.prototype.job = <span class="string">&quot;students&quot;</span>;</span><br><span class="line">Person.prototype.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	alert(<span class="built_in">this</span>.name);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> person1 = <span class="keyword">new</span> Person();</span><br><span class="line"><span class="built_in">console</span>.log(person1.hasOwnProperty(<span class="string">&quot;name&quot;</span>));</span><br><span class="line"><span class="comment">//输出false</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li>原型与<code>in</code>操作符<ul>
<li>单独使用<code>in</code>操作符</li>
<li>在<code>for-in</code>循环中使用<h3 id="1-2-4-组合使用构造函数和原型模式"><a href="#1-2-4-组合使用构造函数和原型模式" class="headerlink" title="1.2.4. 组合使用构造函数和原型模式"></a>1.2.4. 组合使用构造函数和原型模式</h3><h3 id="1-2-5-动态原型模式"><a href="#1-2-5-动态原型模式" class="headerlink" title="1.2.5. 动态原型模式"></a>1.2.5. 动态原型模式</h3><h3 id="1-2-6-寄生构造函数模式"><a href="#1-2-6-寄生构造函数模式" class="headerlink" title="1.2.6. 寄生构造函数模式"></a>1.2.6. 寄生构造函数模式</h3><h3 id="1-2-7-稳妥构造函数模式"><a href="#1-2-7-稳妥构造函数模式" class="headerlink" title="1.2.7. 稳妥构造函数模式"></a>1.2.7. 稳妥构造函数模式</h3></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/HTML/%E8%A1%A5%E5%85%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱辉">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhuhui's yard">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/17/Note/%E7%AC%94%E8%AE%B0/WEB/HTML/%E8%A1%A5%E5%85%85/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-17 21:04:46" itemprop="dateCreated datePublished" datetime="2021-07-17T21:04:46+08:00">2021-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-19 10:26:15" itemprop="dateModified" datetime="2021-06-19T10:26:15+08:00">2021-06-19</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>36</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="补充知识"><a href="#补充知识" class="headerlink" title="补充知识"></a>补充知识</h3><ul>
<li>为网页标题添加一个小图标<br>  <a target="_blank" rel="noopener" href="https://blog.csdn.net/mico_cmm/article/details/79368800?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-3.channel_param&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-3.channel_param">添加图标</a></li>
<li>div元素获得焦点<br>  <a target="_blank" rel="noopener" href="https://blog.csdn.net/jdsxzhao/article/details/41948783">div获得焦点</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="朱辉"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">朱辉</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">129</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021-7-16 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">朱辉</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">286k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:20</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
